<!-- Librairies JS -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expobeton-Email - Gestion d'Emails</title>
    <script>
        // Protection : V√©rifier l'authentification
        // V√©rification JWT
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        // Fonction de d√©connexion
        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/login.html';
        }

        // V√©rifier imm√©diatement
        if (!checkAuth()) {
            // Redirection en cours
        }

        // Utilitaire pour requ√™tes API avec JWT
        async function apiFetch(url, options = {}) {
            const token = localStorage.getItem('jwt_token');
            options.headers = options.headers || {};
            if (token) {
                options.headers['Authorization'] = 'Bearer ' + token;
            }
            return fetch(url, options);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4C6FFF;
            --primary-dark: #3D5BD9;
            --secondary: #6C63FF;
            --accent: #FF6B8B;
            --success: #2ED573;
            --danger: #FF4757;
            --warning: #FFA502;
            --background: #0A0A1A;
            --surface: rgba(30, 30, 50, 0.95);
            --surface-light: rgba(40, 40, 60, 0.95);
            --text-bright: #FFFFFF;
            --text-medium: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.7);
            --border: rgba(76, 111, 255, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: var(--text-bright);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(30, 30, 50, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #26AE60 100%);
            color: white;
        }

        .primary-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-bright);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
            color: white;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .logout-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.5);
            background: linear-gradient(135deg, #c44569 0%, #ff4757 100%);
        }

        .logout-btn:hover::before {
            left: 100%;
        }

        .logout-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .logout-btn::after {
            content: 'üö™';
            font-size: 1.1em;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .logout-btn:hover::after {
            transform: translateX(3px);
        }

        /* Animation de pulsation pour attirer l'attention */
        @keyframes logoutPulse {
            0% { box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 71, 87, 0.5); }
            100% { box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        }

        .logout-btn {
            animation: logoutPulse 3s infinite;
        }

        .logout-btn:hover {
            animation: none;
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .card {
            background: var(--surface);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--text-bright);
            font-size: 1.4em;
            font-weight: 600;
        }

        /* Import Section Styles */
        .import-section {
            margin-bottom: 30px;
        }

        .import-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--surface-light);
        }

        .import-area:hover {
            border-color: var(--primary);
            background: rgba(76, 111, 255, 0.05);
        }

        .import-placeholder {
            color: var(--text-medium);
        }

        .import-placeholder p {
            margin: 5px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Styles am√©lior√©s pour tous les boutons */
        .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Effet de brillance au survol */
        .btn::before, .secondary-btn::before, .danger-btn::before, .success-btn::before, .primary-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before, .secondary-btn:hover::before, .danger-btn:hover::before, .success-btn:hover::before, .primary-btn:hover::before {
            left: 100%;
        }

        /* Bouton Actualiser - Effet de rotation */
        .secondary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-bright);
            border: 2px solid transparent;
        }

        .secondary-btn:hover {
            transform: translateY(-2px) rotate(1deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .secondary-btn:active {
            transform: translateY(0) rotate(0deg);
        }

        /* Ic√¥ne de rotation pour Actualiser */
        .secondary-btn::after {
            content: 'üîÑ';
            font-size: 1.1em;
        }

        /* Bouton Vider tous les contacts - Effet de secousse */
        .danger-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);
            color: var(--text-bright);
            border: 2px solid transparent;
            position: relative;
        }

        .danger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            background: linear-gradient(135deg, #ee5253 0%, #ff6b6b 100%);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) translateY(-2px); }
            25% { transform: translateX(-5px) translateY(-2px); }
            75% { transform: translateX(5px) translateY(-2px); }
        }

        .danger-btn::after {
            content: 'üóëÔ∏è';
            font-size: 1.1em;
        }

        /* Bouton Exporter les contacts - Effet de pulsation */
        .success-btn {
            background: linear-gradient(135deg, #2ed573 0%, #26ae60 100%);
            color: var(--text-bright);
            border: 2px solid transparent;
        }

        .success-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4);
            background: linear-gradient(135deg, #26ae60 0%, #2ed573 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4); }
            50% { box-shadow: 0 8px 35px rgba(46, 213, 115, 0.6); }
            100% { box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4); }
        }

        .success-btn::after {
            content: 'üì•';
            font-size: 1.1em;
        }

        /* Bouton Envoyer le nombre sp√©cifi√© - Effet de glow */
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: var(--text-bright);
            border: 2px solid transparent;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .btn-success::after {
            content: 'üìß';
            font-size: 1.1em;
        }

        /* Bouton Envoyer √† TOUS - Effet d'√©chelle */
        .primary-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: var(--text-bright);
            border: 2px solid transparent;
            font-weight: 700;
            font-size: 1.05em;
        }

        .primary-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 35px rgba(250, 112, 154, 0.4);
            background: linear-gradient(135deg, #fee140 0%, #fa709a 100%);
        }

        .primary-btn::after {
            content: 'üöÄ';
            font-size: 1.2em;
        }

        /* Effet de chargement pour tous les boutons */
        .btn.loading, .secondary-btn.loading, .danger-btn.loading, .success-btn.loading, .primary-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn.loading::after, .secondary-btn.loading::after, .danger-btn.loading::after, .success-btn.loading::after, .primary-btn.loading::after {
            content: '‚è≥';
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive pour les boutons */
        @media (max-width: 768px) {
            .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                width: 100%;
                justify-content: center;
            }
            
            .add-row-btn,
            .send-manual-btn,
            .clear-manual-btn {
                width: auto;
                max-width: 200px;
                justify-self: flex-start;
                font-size: 0.85em;
                padding: 8px 12px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }

        .email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--surface-light);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .email-item.sent {
            opacity: 0.7;
            border-color: var(--success);
        }

        .email-info strong {
            color: var(--primary);
        }

        .email-status {
            font-size: 0.9em;
            font-weight: 600;
        }

        .form-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: rgba(255,255,255,0.9);
            font-size: 0.95em;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface-light);
            color: var(--text-bright);
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.2);
            background: var(--surface);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .email-list {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Styles pour l'envoi manuel */
        .manual-send-section {
            margin-top: 30px;
        }

        .manual-inputs {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            align-items: center;
        }

        .input-row input {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--surface-light);
            color: var(--text-bright);
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .input-row input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.2);
            background: var(--surface);
        }

        .input-row input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #D63031;
            transform: scale(1.1);
        }

        .add-row-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            width: auto;
            max-width: 250px;
            justify-self: flex-start;
        }

        .add-row-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .manual-emails-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .manual-email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--surface-light);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .manual-email-info {
            flex: 1;
        }

        .manual-email-info strong {
            color: var(--primary);
            display: block;
            margin-bottom: 4px;
        }

        .manual-email-info small {
            color: rgba(255, 255, 255, 0.7);
        }

        .manual-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .send-manual-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 28px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-manual-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .clear-manual-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 28px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-manual-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        /* ===== DESIGN RESPONSIVE COMPLET ===== */
        
        /* Variables pour responsive */
        :root {
            --mobile-breakpoint: 480px;
            --tablet-breakpoint: 768px;
            --desktop-breakpoint: 1024px;
            --large-breakpoint: 1200px;
        }

        /* Responsive g√©n√©ral */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 10px;
            position: relative;
            overflow-x: hidden;
            color: var(--text-bright);
            line-height: 1.6;
            font-size: 16px; /* Base 16px pour accessibilit√© */
        }

        .container {
            max-width: var(--large-breakpoint)px;
            margin: 0 auto;
            padding: 0 10px;
        }

        /* Header Responsive */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 30, 50, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            flex: 1;
            min-width: 200px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Cartes Responsive */
        .card {
            background: var(--surface);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            width: 100%;
        }

        .card h2 {
            margin-bottom: 15px;
            color: var(--text-bright);
            font-size: clamp(1.2rem, 3vw, 1.4rem);
            font-weight: 600;
        }

        /* Import Section Responsive */
        .import-section {
            margin-bottom: 20px;
        }

        .import-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: clamp(20px, 5vw, 40px);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--surface-light);
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .import-placeholder {
            color: var(--text-medium);
        }

        .import-placeholder div {
            font-size: clamp(2rem, 5vw, 3em);
            margin-bottom: 10px;
        }

        .import-placeholder p {
            margin: 5px 0;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        /* Boutons Responsive Universels */
        .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn,
        .btn-success, .logout-btn, .send-manual-btn, .clear-manual-btn, .add-row-btn {
            padding: clamp(10px, 2.5vw, 14px) clamp(16px, 4vw, 28px);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: clamp(0.85rem, 2vw, 0.95em);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 44px; /* Accessibilit√© iOS */
            min-width: 44px;
            touch-action: manipulation;
        }

        /* Action Buttons Responsive */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-actions, .manual-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        /* Formulaires Responsive */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255,255,255,0.9);
            font-size: clamp(0.9rem, 2vw, 0.95em);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: clamp(12px, 3vw, 18px);
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface-light);
            color: var(--text-bright);
            font-size: clamp(0.9rem, 2.2vw, 1em);
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 44px; /* Accessibilit√© */
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.2);
            background: var(--surface);
        }

        /* Envoi Manuel Responsive */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        .manual-emails-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .manual-email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--surface-light);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .manual-email-info {
            flex: 1;
            min-width: 0;
        }

        .manual-email-info strong {
            color: var(--primary);
            display: block;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .manual-email-info small {
            color: rgba(255, 255, 255, 0.7);
            word-break: break-all;
        }

        /* Email List Responsive */
        .email-list, .manual-emails-list {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
        }

        .email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--surface-light);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .email-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .email-info strong {
            color: var(--primary);
            display: block;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .email-info small {
            color: rgba(255, 255, 255, 0.7);
            word-break: break-all;
        }

        /* Alertes Responsive */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        /* ===== BREAKPOINTS SP√âCIFIQUES ===== */

        /* Mobile (jusqu'√† 480px) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 14px;
            }

            .container {
                padding: 10px;
                margin: 5px;
            }

            .app-layout {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
                margin-bottom: 10px;
            }

            .main-content {
                width: 100%;
                padding: 10px;
            }

            .header {
                padding: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn {
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                font-size: 16px; /* Taille minimum pour iOS */
            }

            .file-input {
                padding: 20px;
                font-size: 14px;
            }

            .email-list {
                max-height: 250px;
            }

            .email-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .input-row {
                flex-direction: column;
                gap: 10px;
            }

            .input-row input {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
                padding: 15px;
            }

            .tracking-widget {
                padding: 15px;
            }

            .tracking-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .tracking-list {
                max-height: 200px;
            }

            .tracking-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* Optimisations tactiles */
            .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn {
                min-height: 48px; /* Taille minimum pour le touch */
                touch-action: manipulation; /* D√©sactiver le double-tap zoom */
            }
            
            .email-item {
                min-height: 60px; /* Espace suffisant pour le touch */
                touch-action: manipulation;
            }
            
            .stat-card {
                min-height: 80px;
                touch-action: manipulation;
            }
            
            input[type="file"], input[type="text"], input[type="email"], textarea {
                min-height: 44px; /* Taille minimum pour le touch */
                font-size: 16px; /* √âviter le zoom sur iOS */
            }
            
            /* Navigation mobile */
            .nav-item {
                padding: 15px;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* Modal mobile */
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Scroll optimis√© */
            .email-list, .tracking-list {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
        }

        /* Tablette (481px √† 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 15px;
            }
            
            .app-layout {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .main-content {
                width: 100%;
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .section {
                padding: 20px;
            }
            
            .btn, .secondary-btn, .danger-btn, .success-btn, .primary-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                margin: 5px;
            }
            
            .file-input {
                padding: 30px;
            }
            
            .email-list {
                max-height: 300px;
            }
            
            .input-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .input-row input {
                flex: 1;
                min-width: 200px;
            }
            
            .modal-content {
                width: 90%;
                padding: 20px;
            }
            
            .tracking-widget {
                padding: 20px;
            }
            
            .tracking-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .tracking-list {
                max-height: 250px;
            }
        }

        /* Desktop (769px √† 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 0 12px;
            }

            .main-content {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .import-section {
                width: 100%;
            }

            .manual-send-section {
                width: 100%;
            }
        }

        /* Large Desktop (1025px et plus) */
        @media (min-width: 1025px) {
            body {
                padding: 20px;
            }

            .main-content {
                display: flex;
                flex-direction: column;
                gap: 30px;
            }

            .import-section {
                width: 100%;
            }

            .manual-send-section {
                width: 100%;
            }

            .action-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Ultra Large (1440px et plus) */
        @media (min-width: 1440px) {
            .container {
                max-width: 1400px;
            }

            .main-content {
                display: flex;
                flex-direction: column;
                gap: 30px;
            }
        }

        /* ===== COMPATIBILIT√â NAVIGATEUR ===== */

        /* Support vieux navigateurs */
        @supports not (backdrop-filter: blur(10px)) {
            .card, .header {
                background: rgba(30, 30, 50, 0.95);
            }
        }

        /* Safari iOS */
        @supports (-webkit-touch-callout: none) {
            .btn, input, textarea {
                -webkit-appearance: none;
                border-radius: 12px;
            }
        }

        /* Firefox */
        @supports (-moz-appearance: none) {
            input[type="email"] {
                -moz-appearance: none;
            }
        }

        /* Edge/IE */
        @supports (-ms-ime-align: auto) {
            .card {
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }
        }

        /* ===== ACCESSIBILIT√â ===== */

        /* Focus visible pour navigation clavier */
        .btn:focus-visible,
        input:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Mode contraste √©lev√© */
        @media (prefers-contrast: high) {
            :root {
                --border: rgba(76, 111, 255, 0.8);
                --text-medium: rgba(255, 255, 255, 0.95);
            }
        }

        /* Mode r√©duit mouvement */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Mode sombre clair */
        @media (prefers-color-scheme: light) {
            :root {
                --background: #f8f9fa;
                --surface: rgba(255, 255, 255, 0.95);
                --surface-light: rgba(248, 249, 250, 0.8);
                --text-bright: #212529;
                --text-medium: #495057;
                --text-dim: #6c757d;
            }
        }

        /* ===== BARRE LAT√âRALE ===== */
        
        .app-layout {
            display: flex;
            min-height: 100vh;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            background: var(--surface);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 20px;
            height: fit-content;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            color: var(--text-medium);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-bright);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .nav-text {
            flex: 1;
        }

        .nav-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sidebar-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            color: var(--text-bright);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-role {
            color: var(--text-medium);
            font-size: 0.8rem;
        }

        .main-content-area {
            flex: 1;
            min-width: 0;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Sidebar */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
                margin-bottom: 20px;
            }

            .nav-link {
                padding: 12px 14px;
            }

            .nav-icon {
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 15px;
            }

            .sidebar-header h2 {
                font-size: 1.3rem;
            }

            .nav-link {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
            }
        }

        /* ===== FIN BARRE LAT√âRALE ===== */
    </style>
</head>
<body>
    <div class="container">
        <div class="app-layout">
            <!-- Barre Lat√©rale -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Expobeton-Email</h2>
                    <p>Plateforme d'emailing</p>
                </div>
                
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-section="import">
                                <span class="nav-icon">üìä</span>
                                <span class="nav-text">Importation</span>
                                <span class="nav-badge" id="importBadge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="contacts">
                                <span class="nav-icon">üë•</span>
                                <span class="nav-text">Contacts</span>
                                <span class="nav-badge" id="contactBadge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="send">
                                <span class="nav-icon">üìß</span>
                                <span class="nav-text">Envoi Group√©</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="manual">
                                <span class="nav-icon">‚úçÔ∏è</span>
                                <span class="nav-text">Envoi Manuel</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-section="stats">
                                <span class="nav-icon">üìà</span>
                                <span class="nav-text">Statistiques</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <div class="user-details">
                            <div class="user-name">Admin</div>
                            <div class="user-role">Administrateur</div>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.8em;">
                        <div style="margin-bottom: 8px;">
                            <strong>üîß Support Technique :</strong>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <a href="tel:+212600989761" style="color: #667eea; text-decoration: none;">+212 600-989-761</a>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <a href="mailto:webconsulting66@gmail.com" style="color: #667eea; text-decoration: none;">webconsulting66@gmail.com</a>
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <a href="https://webconsulting.vercel.app" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; font-weight: bold;">
                                üîß Webconsulting
                            </a>
                        </div>
                        <div style="text-align: center; margin-top: 8px; font-size: 0.7em;">
                            <a href="/mentions-legales.html" style="color: rgba(255,255,255,0.5); text-decoration: none;">
                                üìã Mentions l√©gales
                            </a>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="logout-btn" style="width: 100%;">
                        <span>D√©connexion</span>
                        <span>üö™</span>
                    </button>
                </div>
            </aside>
            
            <!-- Zone de Contenu Principal -->
            <main class="main-content-area">
                <!-- Section Importation -->
                <section class="content-section active" id="import-section">
                    <div class="card import-section">
                        <div class="card-header">
                            <h2>ÔøΩ Importation de contacts</h2>
                        </div>
                        <div class="form-content">
                            <div class="import-area" onclick="document.getElementById('importFile').click()">
                                <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;" />
                                <div class="import-placeholder">
                                    <div style="font-size: 3em; margin-bottom: 10px;">üìä</div>
                                    <p><strong>Cliquez pour importer un fichier</strong></p>
                                    <p style="font-size: 0.9em; color: rgba(255,255,255,0.5);">Formats support√©s: CSV, Excel (.xlsx, .xls)</p>
                                </div>
                            </div>
                            <div id="importStatus" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </section>
                
                <!-- Section Contacts -->
                <section class="content-section" id="contacts-section">
                    <div class="card action-card">
                        <h2>üìã Gestion des contacts</h2>
                        <div class="action-buttons">
                            <button onclick="loadContacts()" class="secondary-btn">Actualiser</button>
                            <button onclick="clearAllContacts()" class="danger-btn">Vider tous les contacts</button>
                            <button onclick="exportContacts()" class="success-btn">Exporter les contacts</button>
                        </div>
                        <div id="contactStats" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 8px;">
                            <strong>Total contacts:</strong> <span id="totalContacts">0</span>
                        </div>
                    </div>
                    
                    <div class="card email-card" id="emailsCard">
                        <div class="card-header">
                            <h2>Contacts import√©s</h2>
                            <div class="card-actions">
                                <span style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Organisation | Email</span>
                            </div>
                        </div>
                        <div id="emailList" class="email-list">
                            <p style="text-align: center; color: #999;">Importez un fichier pour voir les contacts</p>
                        </div>
                    </div>
                </section>
                
                <!-- Section Envoi Group√© -->
                <section class="content-section" id="send-section">
                    <div class="card email-form" id="sendCard">
                        <div class="card-header">
                            <h2>Envoyer les emails</h2>
                        </div>
                        <div class="form-content">
                            <div class="form-group">
                                <label for="subject">Sujet</label>
                                <input type="text" id="subject" placeholder="Ex: Information importante">
                            </div>
                            <div class="form-group">
                                <label for="message">Message</label>
                                <textarea id="message" placeholder="√âcrivez votre message ici..." rows="6"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="emailCount">Nombre d'emails √† envoyer</label>
                                <input type="number" id="emailCount" placeholder="Ex: 100" min="1">
                                <small style="color: rgba(255,255,255,0.5);">Maximum: <span id="maxEmails">0</span> contacts disponibles</small>
                            </div>
                            <div class="form-actions">
                                <button onclick="sendCustomEmails()" class="success-btn">Envoyer le nombre sp√©cifi√©</button>
                                <button onclick="sendEmails(999999)" class="primary-btn">Envoyer √† TOUS</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Section Envoi Manuel -->
                <section class="content-section" id="manual-section">
                    <div class="card manual-send-section">
                        <div class="card-header">
                            <h2>‚úçÔ∏è Envoi manuel d'emails</h2>
                        </div>
                        <div class="form-content">
                            <div class="form-group">
                                <label>Ajouter des destinataires manuellement</label>
                                <div class="manual-inputs" id="manualInputs">
                                    <div class="input-row">
                                        <input type="text" placeholder="Organisation" class="manual-org">
                                        <input type="email" placeholder="Email" class="manual-email">
                                        <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
                                    </div>
                                </div>
                                <button class="add-row-btn" onclick="addManualRow()">
                                    <span>‚ûï</span>
                                    <span>Ajouter un destinataire</span>
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>Liste des destinataires manuels</label>
                                <div class="manual-emails-list" id="manualEmailsList">
                                    <p style="text-align: center; color: #999;">Aucun destinataire ajout√©</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="manualSubject">Sujet</label>
                                <input type="text" id="manualSubject" placeholder="Ex: Information personnalis√©e">
                            </div>
                            <div class="form-group">
                                <label for="manualMessage">Message</label>
                                <textarea id="manualMessage" placeholder="√âcrivez votre message personnalis√©..." rows="6"></textarea>
                            </div>
                            
                            <div class="manual-actions">
                                <button class="send-manual-btn" onclick="sendManualEmails()">
                                    <span>üìß</span>
                                    <span>Envoyer aux destinataires manuels</span>
                                </button>
                                <button class="clear-manual-btn" onclick="clearManualEmails()">
                                    <span>üóëÔ∏è</span>
                                    <span>Vider la liste</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Section Statistiques -->
                <section class="content-section" id="stats-section">
                    <div class="card">
                        <h2>üìà Statistiques</h2>
                        <div style="padding: 20px; text-align: center;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">üë•</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);" id="statTotalContacts">0</div>
                                    <div style="color: var(--text-medium);">Total Contacts</div>
                                </div>
                                <div style="background: rgba(46, 213, 115, 0.1); padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">‚úÖ</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);" id="statSentEmails">0</div>
                                    <div style="color: var(--text-medium);">Emails Envoy√©s</div>
                                </div>
                                <div style="background: rgba(255, 167, 38, 0.1); padding: 20px; border-radius: 12px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: var(--warning);" id="statPendingEmails">0</div>
                                    <div style="color: var(--text-medium);">En Attente</div>
                                </div>
                            </div>
                            <p style="color: var(--text-medium);">Les statistiques se mettent √† jour automatiquement lors de vos actions.</p>
                        </div>
                    </div>
                </section>
                
                <!-- Alertes globales -->
                <div id="alert" class="alert"></div>
            </main>
        </div>
    </div>

    <script>
        // Variables globales
        let importedContacts = [];
        let manualEmails = []; // Stocker les emails manuels
        let isLoadingContacts = false; // √âviter les chargements multiples
        
        // Gestion de l'importation de fichier
        document.getElementById('importFile').addEventListener('change', handleFileImport);
        
        // ===== NAVIGATION ENTRE SECTIONS =====
        
        // G√©rer la navigation        // Initialiser la navigation
        document.addEventListener('DOMContentLoaded', async () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    const targetSection = link.getAttribute('data-section');
                    if (!targetSection) return;
                    
                    // Mettre √† jour les liens actifs
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Afficher la section correspondante
                    await showSection(targetSection);
                });
            });
            
            // Initialiser les statistiques
            await updateStatistics();
        });
        
        // Afficher une section sp√©cifique
        async function showSection(sectionName) {
            // Masquer toutes les sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Masquer tous les contenus de statistiques
            document.querySelectorAll('.stats-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Afficher la section demand√©e
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Mettre √† jour les donn√©es sp√©cifiques √† la section
            if (sectionName === 'contacts') {
                // Ne recharger les contacts que s'ils ne sont pas d√©j√† charg√©s
                if (importedContacts.length === 0) {
                    await loadContacts();
                }
            } else if (sectionName === 'stats') {
                await updateStatistics();
            }
            
            await updateNavBadges();
        }
        
        // Mettre √† jour les badges de navigation avec les vraies statistiques
        async function updateNavBadges() {
            const importBadge = document.getElementById('importBadge');
            const contactBadge = document.getElementById('contactBadge');
            
            try {
                // R√©cup√©rer les vraies statistiques depuis l'API
                const res = await apiFetch('/api/dashboard-stats');
                const data = await res.json();
                
                if (data.success && data.stats) {
                    const totalSent = data.stats.totalSent || 0;
                    const totalOpened = data.stats.totalOpened || 0;
                    
                    // Mettre √† jour le badge d'importation avec le nombre total d'envois
                    if (importBadge) {
                        importBadge.textContent = totalSent > 0 ? totalSent.toString() : '0';
                    }
                    
                    // Mettre √† jour le badge de contacts avec le nombre d'ouvertures
                    if (contactBadge) {
                        contactBadge.textContent = totalOpened > 0 ? totalOpened.toString() : '0';
                    }
                } else {
                    // Fallback sur les contacts import√©s si l'API ne r√©pond pas
                    if (importBadge) {
                        importBadge.textContent = importedContacts.length > 0 ? importedContacts.length : '0';
                    }
                    if (contactBadge) {
                        contactBadge.textContent = importedContacts.length > 0 ? importedContacts.length : '0';
                    }
                }
            } catch (error) {
                console.error('Erreur mise √† jour badges:', error);
                // Fallback sur les contacts import√©s en cas d'erreur
                if (importBadge) {
                    importBadge.textContent = importedContacts.length > 0 ? importedContacts.length : '0';
                }
                if (contactBadge) {
                    contactBadge.textContent = importedContacts.length > 0 ? importedContacts.length : '0';
                }
            }
        }
        
        // Mettre √† jour les statistiques
        async function updateStatistics() {
            const totalContacts = importedContacts.length;
            const sentEmails = importedContacts.filter(c => c.sent).length;
            const pendingEmails = totalContacts - sentEmails;
            
            const statTotalContacts = document.getElementById('statTotalContacts');
            const statSentEmails = document.getElementById('statSentEmails');
            const statPendingEmails = document.getElementById('statPendingEmails');
            
            if (statTotalContacts) statTotalContacts.textContent = totalContacts;
            if (statSentEmails) statSentEmails.textContent = sentEmails;
            if (statPendingEmails) statPendingEmails.textContent = pendingEmails;
            
            await updateNavBadges();
        }
        
        // ===== FIN NAVIGATION =====
        
        // ===== FONCTIONS POUR L'ENVOI MANUEL =====
        
        // Ajouter une ligne d'entr√©e manuelle
        function addManualRow() {
            const container = document.getElementById('manualInputs');
            const row = document.createElement('div');
            row.className = 'input-row';
            row.innerHTML = `
                <input type="text" placeholder="Organisation" class="manual-org">
                <input type="email" placeholder="Email" class="manual-email">
                <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
            `;
            container.appendChild(row);
        }
        
        // Supprimer une ligne d'entr√©e manuelle
        function removeManualRow(button) {
            const row = button.parentElement;
            row.remove();
            updateManualEmailsList();
        }
        
        // Charger les destinataires manuels depuis le serveur
        async function loadManualRecipients() {
            try {
                const res = await apiFetch('/api/manual-recipients');
                const data = await res.json();
                
                if (data.success) {
                    manualEmails = data.recipients || [];
                    console.log(`üìÇ ${manualEmails.length} destinataires manuels charg√©s depuis le serveur`);
                    
                    // Mettre √† jour l'affichage
                    const container = document.getElementById('manualInputs');
                    if (manualEmails.length === 0) {
                        container.innerHTML = `
                            <div class="input-row">
                                <input type="text" placeholder="Organisation" class="manual-org">
                                <input type="email" placeholder="Email" class="manual-email">
                                <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
                            </div>
                        `;
                    } else {
                        container.innerHTML = manualEmails.map(recipient => `
                            <div class="input-row">
                                <input type="text" placeholder="Organisation" class="manual-org" value="${recipient.organisation || ''}">
                                <input type="email" placeholder="Email" class="manual-email" value="${recipient.email}">
                                <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
                            </div>
                        `).join('');
                    }
                    
                    updateManualEmailsList();
                }
            } catch (error) {
                console.error('Erreur chargement destinataires manuels:', error);
            }
        }
        
        // Sauvegarder les destinataires manuels sur le serveur
        async function saveManualRecipients() {
            try {
                const res = await apiFetch('/api/manual-recipients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipients: manualEmails })
                });
                
                const data = await res.json();
                if (data.success) {
                    console.log(`üíæ ${manualEmails.length} destinataires manuels sauvegard√©s sur le serveur`);
                }
            } catch (error) {
                console.error('Erreur sauvegarde destinataires manuels:', error);
            }
        }
        
        // Mettre √† jour la liste des emails manuels
        function updateManualEmailsList() {
            manualEmails = [];
            const rows = document.querySelectorAll('#manualInputs .input-row');
            
            rows.forEach(row => {
                const org = row.querySelector('.manual-org').value.trim();
                const email = row.querySelector('.manual-email').value.trim();
                
                if (email) {
                    manualEmails.push({ organisation: org, email });
                }
            });
            
            // Sauvegarder automatiquement apr√®s chaque modification
            saveManualRecipients();
        }
        
        // Supprimer un email manuel sp√©cifique
        function removeManualEmail(index) {
            manualEmails.splice(index, 1);
            
            // Reconstruire les champs d'entr√©e
            const container = document.getElementById('manualInputs');
            container.innerHTML = '';
            
            manualEmails.forEach(contact => {
                const row = document.createElement('div');
                row.className = 'input-row';
                row.innerHTML = `
                    <input type="text" placeholder="Organisation" class="manual-org" value="${contact.organisation}">
                    <input type="email" placeholder="Email" class="manual-email" value="${contact.email}">
                    <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
                `;
                container.appendChild(row);
            });
            
            // Ajouter une ligne vide si n√©cessaire
            if (container.children.length === 0) {
                addManualRow();
            }
            
            updateManualEmailsList();
        }
        
        // Vider tous les emails manuels
        async function clearManualEmails() {
            const confirmed = await showConfirmModal({
                title: 'üóëÔ∏è Vidage des destinataires',
                emailsToSend: manualEmails.length,
                totalContacts: manualEmails.length,
                pendingContacts: manualEmails.length,
                subject: 'Tous les destinataires manuels seront supprim√©s'
            });
            if (!confirmed) return;
            
            try {
                await apiFetch('/api/manual-recipients', { method: 'DELETE' });
                
                manualEmails = [];
                const container = document.getElementById('manualInputs');
                container.innerHTML = `
                    <div class="input-row">
                        <input type="text" placeholder="Organisation" class="manual-org">
                        <input type="email" placeholder="Email" class="manual-email">
                        <button class="remove-btn" onclick="removeManualRow(this)">√ó</button>
                    </div>
                `;
                updateManualEmailsList();
                showAlert('‚úÖ Liste des destinataires vid√©e', 'success');
            } catch (error) {
                showAlert('‚ùå Erreur lors de la suppression', 'error');
            }
        }
        
        // Envoyer les emails manuels
        async function sendManualEmails() {
            updateManualEmailsList(); // Mettre √† jour la liste avant envoi
            
            if (manualEmails.length === 0) {
                showAlert('‚ùå Aucun destinataire √† envoyer', 'error');
                return;
            }
            
            const subject = document.getElementById('manualSubject').value.trim();
            const message = document.getElementById('manualMessage').value.trim();
            
            if (!subject || !message) {
                showAlert('‚ùå Veuillez remplir le sujet et le message', 'error');
                return;
            }
            
            // Afficher le popup de confirmation
            const confirmed = await showConfirmModal({
                title: 'üìß Envoi manuel d\'emails',
                emailsToSend: manualEmails.length,
                totalContacts: manualEmails.length,
                pendingContacts: manualEmails.length,
                subject: subject
            });
            
            if (!confirmed) return;
            
            showAlert('‚è≥ Envoi des emails manuels en cours...', 'success');
            
            try {
                const res = await apiFetch('/api/send-manual-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        subject, 
                        message, 
                        contacts: manualEmails 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showAlert(`‚úÖ ${data.sent} emails envoy√©s avec succ√®s!`, 'success');
                    // Vider les champs apr√®s envoi r√©ussi
                    document.getElementById('manualSubject').value = '';
                    document.getElementById('manualMessage').value = '';
                    // Garder les destinataires pour pouvoir r√©utiliser
                    saveManualRecipients(); // Sauvegarder la liste actuelle
                    
                    // Mettre √† jour les badges avec les nouvelles statistiques
                    await updateNavBadges();
                    
                    // Mettre √† jour le widget de suivi s'il existe
                    if (typeof loadEmailTracking === 'function') {
                        loadEmailTracking();
                    }
                } else {
                    showAlert('‚ùå Erreur lors de l\'envoi', 'error');
                }
            } catch (e) {
                console.error('‚ùå Erreur envoi manuel:', e);
                showAlert('‚ùå Erreur: ' + e.message, 'error');
            }
        }
        
        // √âcouter les changements dans les champs manuels
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('manual-org') || e.target.classList.contains('manual-email')) {
                updateManualEmailsList();
            }
        });
        
        // ===== FIN FONCTIONS ENVOI MANUEL =====
        
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const importStatus = document.getElementById('importStatus');
            importStatus.innerHTML = '<p style="color: #FFA502;">‚è≥ Lecture du fichier en cours...</p>';
            
            try {
                const contacts = await parseFile(file);
                console.log(`üì§ ENVOI AU BACKEND: ${contacts.length} contacts √† importer`);
                console.log('üìã Premier contact envoy√©:', contacts[0]);
                
                // Envoyer les contacts au backend
                const response = await apiFetch('/api/import-contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contacts })
                });
                
                const result = await response.json();
                console.log('üì• R√âPONSE BACKEND:', result);
                
                if (result.success) {
                    importStatus.innerHTML = `<p style="color: #2ED573;">‚úÖ ${contacts.length} contacts import√©s avec succ√®s!</p>`;
                    console.log('‚úÖ Importation r√©ussie, appel de loadContacts()...');
                    await loadContacts();
                    await updateNavBadges(); // Mettre √† jour les badges avec les nouveaux chiffres
                    showAlert(`‚úÖ ${contacts.length} contacts import√©s`, 'success');
                } else {
                    importStatus.innerHTML = '<p style="color: #FF4757;">‚ùå Erreur lors de l\'importation</p>';
                    showAlert('‚ùå Erreur lors de l\'importation', 'error');
                }
            } catch (error) {
                console.error('Erreur import:', error);
                importStatus.innerHTML = '<p style="color: #FF4757;">‚ùå Erreur: ' + error.message + '</p>';
                showAlert('‚ùå Erreur: ' + error.message, 'error');
            }
            
            // R√©initialiser le input file
            event.target.value = '';
        }
        
        // Parser le fichier (CSV ou Excel)
        async function parseFile(file) {
            return new Promise((resolve, reject) => {
                let rawData = null; // D√©clarer rawData ici pour qu'il soit accessible partout
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        let data = [];
                        console.log('üìÅ Parsing du fichier:', file.name, file.type);
                        
                        if (file.name.endsWith('.csv')) {
                            // Parser CSV avec PapaParse pour plus de robustesse
                            Papa.parse(e.target.result, {
                                header: false,
                                skipEmptyLines: true,
                                complete: function(results) {
                                    console.log('üìä CSV brut:', results.data);
                                    
                                    // DIAGNOSTIC COMPLET DU CSV
                                    console.log('üîç DIAGNOSTIC COMPLET DU FICHIER CSV');
                                    console.log('='.repeat(70));
                                    console.log(`üìÅ Fichier: ${file.name}`);
                                    console.log(`üìè Taille: ${results.data.length} lignes`);
                                    console.log(`üìä Structure: ${results.data[0] ? results.data[0].length : 0} colonnes`);
                                    
                                    // Analyser chaque ligne en d√©tail
                                    console.log('\nüìç ANALYSE D√âTAILL√âE DES LIGNES:');
                                    results.data.forEach((row, index) => {
                                        if (index < 10) { // Premier 10 lignes seulement
                                            console.log(`\n--- LIGNE ${index + 1} ---`);
                                            console.log(`Brut:`, JSON.stringify(row));
                                            
                                            row.forEach((cell, colIndex) => {
                                                const cellStr = String(cell || '').trim();
                                                console.log(`  Colonne ${colIndex}: "${cellStr}"`);
                                                console.log(`    ‚Üí Longueur: ${cellStr.length}`);
                                                console.log(`    ‚Üí Contient @: ${cellStr.includes('@')}`);
                                                
                                                // Test email
                                                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                                const isEmail = emailRegex.test(cellStr);
                                                console.log(`    ‚Üí Est un email: ${isEmail}`);
                                                
                                                if (isEmail) {
                                                    console.log(`    ‚úÖ EMAIL VALIDE: "${cellStr}"`);
                                                } else if (cellStr.includes('@')) {
                                                    console.log(`    ‚ö†Ô∏è CONTIENT @ MAIS INVALIDE: "${cellStr}"`);
                                                }
                                            });
                                        }
                                    });
                                    
                                    // Compter les emails dans tout le fichier
                                    let totalEmails = 0;
                                    let totalOrgs = 0;
                                    let emailExamples = [];
                                    let orgExamples = [];
                                    
                                    results.data.forEach((row, index) => {
                                        row.forEach((cell, colIndex) => {
                                            const cellStr = String(cell || '').trim();
                                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                            
                                            if (emailRegex.test(cellStr)) {
                                                totalEmails++;
                                                if (emailExamples.length < 5) {
                                                    emailExamples.push(cellStr);
                                                }
                                            } else if (cellStr.length > 2 && !cellStr.includes('@')) {
                                                totalOrgs++;
                                                if (orgExamples.length < 5) {
                                                    orgExamples.push(cellStr);
                                                }
                                            }
                                        });
                                    });
                                    
                                    console.log('\nüìä STATISTIQUES GLOBALES:');
                                    console.log(`‚Üí Total d'emails valides: ${totalEmails}`);
                                    console.log(`‚Üí Total d'organisations: ${totalOrgs}`);
                                    console.log(`‚Üí Exemples d'emails:`, emailExamples);
                                    console.log(`‚Üí Exemples d'organisations:`, orgExamples);
                                    
                                    if (totalEmails === 0) {
                                        console.log('\n‚ùå PROBL√àME: Aucun email valide trouv√©!');
                                        console.log('üîç Causes possibles:');
                                        console.log('   ‚Ä¢ Format incorrect (ex: "email@domaine" sans .extension)');
                                        console.log('   ‚Ä¢ Espaces en d√©but/fin');
                                        console.log('   ‚Ä¢ Caract√®res sp√©ciaux invalides');
                                        console.log('   ‚Ä¢ Mauvaise colonne (organisations √† la place des emails)');
                                    }
                                    
                                    console.log('\n' + '='.repeat(70));
                                    
                                    data = results.data.map(row => {
                                        // Nettoyer les donn√©es
                                        const cols = row.map(col => String(col || '').trim().replace(/"/g, ''));
                                        return {
                                            organisation: cols[0] || '',
                                            email: cols[1] || ''
                                        };
                                    }).filter(item => item.organisation || item.email); // Garder les lignes avec au moins une donn√©e
                                    
                                    console.log('üìã CSV trait√©:', data);
                                    resolve(data);
                                },
                                error: function(error) {
                                    console.error('‚ùå Erreur PapaParse:', error);
                                    reject(error);
                                }
                            });
                            return; // Sortir de la fonction pour PapaParse
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            // Parser Excel avec XLSX library
                            console.log('üìä Lecture Excel...');
                            
                            try {
                                const workbook = XLSX.read(e.target.result, { 
                                    type: 'binary',
                                    cellDates: false,
                                    cellStyles: false
                                });
                                
                                console.log('üìë Feuilles trouv√©es:', workbook.SheetNames);
                                
                                // V√©rifier qu'il y a bien des feuilles
                                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                    console.error('‚ùå Erreur: Le fichier Excel ne contient aucune feuille');
                                    reject(new Error('Le fichier Excel ne contient aucune feuille de calcul'));
                                    return;
                                }
                                
                                // S√©lectionner la premi√®re feuille existante
                                const firstSheetName = workbook.SheetNames[0];
                                const firstSheet = workbook.Sheets[firstSheetName];
                                
                                console.log(`üìä Feuille s√©lectionn√©e: "${firstSheetName}"`);
                                console.log(`üìä Feuille analys√©e: ${firstSheet.SheetName || 'Nom non d√©fini'}`);
                                
                                // V√©rifier que la feuille existe bien
                                if (!firstSheet) {
                                    console.error(`‚ùå Erreur: Impossible d'acc√©der √† la feuille "${firstSheetName}"`);
                                    reject(new Error(`Impossible d'acc√©der √† la feuille "${firstSheetName}"`));
                                    return;
                                }
                                
                                // V√©rifier si la feuille a une plage de donn√©es d√©finie
                                if (!firstSheet['!ref']) {
                                    console.error('‚ùå Erreur: La feuille Excel n\'a pas de plage de donn√©es d√©finie');
                                    console.log('üîç Causes possibles:');
                                    console.log('   ‚Ä¢ Fichier Excel vide');
                                    console.log('   ‚Ä¢ Feuille de calcul vide');
                                    console.log('   ‚Ä¢ Format Excel non standard');
                                    console.log('   ‚Ä¢ Fichier corrompu');
                                    
                                    // Essayer de trouver des donn√©es manuellement
                                    console.log('\nüîç Recherche manuelle des donn√©es...');
                                    let foundData = false;
                                    let cellCount = 0;
                                    
                                    for (let cellAddress in firstSheet) {
                                        if (cellAddress[0] !== '!' && cellAddress !== '!ref') {
                                            const cell = firstSheet[cellAddress];
                                            if (cell && cell.v) {
                                                console.log(`Cellule trouv√©e ${cellAddress}: "${cell.v}"`);
                                                foundData = true;
                                                cellCount++;
                                            }
                                        }
                                    }
                                    
                                    if (!foundData) {
                                        console.log('‚ùå Aucune donn√©e trouv√©e dans la feuille Excel');
                                        reject(new Error('Le fichier Excel est vide ou ne contient aucune donn√©e lisible'));
                                        return;
                                    } else {
                                        console.log(`‚úÖ ${cellCount} cellules avec donn√©es trouv√©es manuellement`);
                                        console.log('‚ö†Ô∏è Mais la structure n\'est pas standard, tentative de conversion...');
                                    }
                                }
                                
                                const dataRange = firstSheet['!ref'] ? XLSX.utils.decode_range(firstSheet['!ref']) : {s: {c: 0, r: 0}, e: {c: 0, r: 0}};
                                
                                console.log('üìè Plage de donn√©es:', dataRange);
                                
                                // DIAGNOSTIC EXCEL ULTRA-SPECIFIQUE
                                console.log('üîç DIAGNOSTIC EXCEL ULTRA-SPECIFIQUE');
                                console.log('='.repeat(80));
                                console.log(`üìÅ Fichier Excel: ${file.name}`);
                                console.log(`üìä Feuille analys√©e: ${firstSheetName}`);
                                
                                // Afficher la plage de donn√©es en toute s√©curit√©
                                let rangeDisplay = 'Non d√©finie';
                                if (firstSheet['!ref']) {
                                    try {
                                        rangeDisplay = XLSX.utils.encode_range(firstSheet['!ref']);
                                    } catch (error) {
                                        console.warn('‚ö†Ô∏è Erreur encodage plage:', error.message);
                                        rangeDisplay = 'Erreur encodage';
                                    }
                                }
                                console.log(`üìè Plage de donn√©es: ${rangeDisplay}`);
                                
                                // Analyser la structure exacte de la feuille
                                console.log('\nüìã STRUCTURE EXACTE DE LA FEUILLE:');
                                console.log(`‚Üí Plage: ${dataRange.s.c}:${dataRange.s.r} √† ${dataRange.e.c}:${dataRange.e.r}`);
                                console.log(`‚Üí Colonnes: ${dataRange.e.c + 1}`);
                                console.log(`‚Üí Lignes: ${dataRange.e.r + 1}`);
                                
                                // Analyser les cellules individuellement
                                console.log('\nüîç ANALYSE CELLULE PAR CELLULE (premi√®res 5 lignes):');
                                for (let row = 0; row <= Math.min(4, dataRange.e.r); row++) {
                                    console.log(`\n--- LIGNE EXCEL ${row + 1} ---`);
                                    for (let col = 0; col <= Math.min(3, dataRange.e.c); col++) {
                                        const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                                        const cell = firstSheet[cellAddress];
                                        
                                        console.log(`Cellule ${cellAddress}:`);
                                        if (cell) {
                                            const cellValue = String(cell.v || '').trim();
                                            console.log(`  ‚Üí Valeur brute: "${cellValue}"`);
                                            console.log(`  ‚Üí Type Excel: ${cell.t}`);
                                            console.log(`  ‚Üí Format: ${cell.z || 'non d√©fini'}`);
                                            console.log(`  ‚Üí Longueur: ${cellValue.length}`);
                                            console.log(`  ‚Üí Contient @: ${cellValue.includes('@')}`);
                                            
                                            // Test email
                                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                            const isEmail = emailRegex.test(cellValue);
                                            console.log(`  ‚Üí Est un email: ${isEmail}`);
                                            
                                            if (isEmail) {
                                                console.log(`  ‚úÖ EMAIL VALIDE TROUV√â: "${cellValue}"`);
                                            } else if (cellValue.includes('@')) {
                                                console.log(`  ‚ö†Ô∏è CONTIENT @ MAIS INVALIDE: "${cellValue}"`);
                                            } else if (cellValue.length > 2) {
                                                console.log(`  üè¢ POURRAIT √äTRE UNE ENTREPRISE: "${cellValue}"`);
                                            }
                                        } else {
                                            console.log(`  ‚Üí Cellule vide`);
                                        }
                                    }
                                }
                                
                                // Convertir en array brut pour analyse
                                rawData = XLSX.utils.sheet_to_json(firstSheet, { 
                                    header: 1,
                                    defval: '',
                                    blankrows: false
                                });
                                
                                console.log('\nüìä CONVERSION EN ARRAY:');
                                console.log(`‚Üí Nombre de lignes converties: ${rawData.length}`);
                                console.log(`‚Üí Colonnes par ligne: ${rawData[0] ? rawData[0].length : 0}`);
                                
                                // D√âTECTION AUTOMATIQUE DE LA STRUCTURE (pour tous les fichiers)
                                console.log('\nüéØ D√âTECTION AUTOMATIQUE DE LA STRUCTURE EXCEL');
                                console.log(`üìÅ Nom du fichier: "${file.name}"`);
                                console.log(`üìä Feuille analys√©e: "${firstSheetName}"`);
                                
                                let orgCol = 0;
                                let emailCol = 1;
                                
                                // Analyser la structure pour trouver les bonnes colonnes
                                if (rawData.length > 3) {
                                    const headerRow = rawData[2] || []; // Ligne 3 (en-t√™tes)
                                    const firstDataRow = rawData[3] || []; // Ligne 4 (premi√®res donn√©es)
                                    
                                    console.log('üìã En-t√™tes trouv√©s (ligne 3):', headerRow);
                                    console.log('üìç Premi√®res donn√©es (ligne 4):', firstDataRow);
                                    
                                    // D√âTECTION AUTOMATIQUE BAS√âE SUR LA STRUCTURE
                                    console.log('üîç D√©tection automatique de la structure...');
                                    
                                    // Analyser chaque en-t√™te en d√©tail
                                    console.log('\nüîç Analyse d√©taill√©e des en-t√™tes:');
                                    headerRow.forEach((header, index) => {
                                        console.log(`  Colonne ${index}: "${header}"`);
                                        console.log(`    ‚Üí Contient ORGANISATION: ${header && header.toString().includes('ORGANISATION')}`);
                                        console.log(`    ‚Üí Contient NOM: ${header && header.toString().includes('NOM')}`);
                                        console.log(`    ‚Üí Contient E-MAIL: ${header && header.toString().includes('E-MAIL')}`);
                                        console.log(`    ‚Üí Contient EMAIL: ${header && header.toString().includes('EMAIL')}`);
                                        console.log(`    ‚Üí Contient MAIL: ${header && header.toString().includes('MAIL')}`);
                                        console.log(`    ‚Üí Contient e-mail: ${header && header.toString().toLowerCase().includes('e-mail')}`);
                                    });
                                    
                                    // V√©rifier si √ßa ressemble √† la structure expo (feuille "G√©n√©ral")
                                    const hasEmailHeader = headerRow.some(col => 
                                        col && (col.toString().includes('E-MAIL') || col.toString().includes('EMAIL') || col.toString().includes('MAIL') || col.toString().toLowerCase().includes('e-mail'))
                                    );
                                    const hasOrgHeader = headerRow.some(col => 
                                        col && (col.toString().includes('ORGANISATION') || col.toString().includes('NOM'))
                                    );
                                    
                                    console.log(`\nüìä R√©sultats de la d√©tection:`);
                                    console.log(`‚Üí Has Email Header: ${hasEmailHeader}`);
                                    console.log(`‚Üí Has Org Header: ${hasOrgHeader}`);
                                    
                                    if (hasEmailHeader && hasOrgHeader) {
                                        console.log('üéØ Structure expo d√©tect√©e (feuille G√©n√©ral)...');
                                        // Structure: [secteur, organisation, contact, titre, EMAIL, telephone, noms, sources]
                                        orgCol = headerRow.findIndex(col => 
                                            col && (col.toString().includes('ORGANISATION') || col.toString().includes('NOM'))
                                        );
                                        emailCol = headerRow.findIndex(col => 
                                            col && (col.toString().includes('E-MAIL') || col.toString().includes('EMAIL') || col.toString().includes('MAIL') || col.toString().toLowerCase().includes('e-mail'))
                                        );
                                        
                                        console.log(`üîç Recherche colonnes - Organisation trouv√© √†: ${orgCol}, Email trouv√© √†: ${emailCol}`);
                                        
                                        // Si pas trouv√©, utiliser les positions fixes
                                        if (orgCol === -1 || emailCol === -1) {
                                            console.log('‚ö†Ô∏è Colonnes non trouv√©es dans les en-t√™tes, utilisation positions fixes...');
                                            orgCol = 1; // NOM DE L'ORGANISATION
                                            emailCol = 4; // E-MAIL
                                            console.log(`üéØ Positions fixes utilis√©es: Organisation=${orgCol}, Email=${emailCol}`);
                                        }
                                    }
                                    // V√©rifier si √ßa ressemble √† la structure expo (feuille "Feuil1")
                                    else if (headerRow.length >= 3 && firstDataRow.length >= 3) {
                                        console.log('\nüîç Test pour structure Feuil1...');
                                        const thirdColHasEmail = firstDataRow[2] && String(firstDataRow[2]).includes('@');
                                        const secondColHasOrg = firstDataRow[1] && String(firstDataRow[1]).length > 3;
                                        
                                        console.log(`‚Üí Troisi√®me colonne a email: ${thirdColHasEmail}`);
                                        console.log(`‚Üí Deuxi√®me colonne a organisation: ${secondColHasOrg}`);
                                        console.log(`‚Üí Contenu troisi√®me colonne: "${firstDataRow[2]}"`);
                                        console.log(`‚Üí Contenu deuxi√®me colonne: "${firstDataRow[1]}"`);
                                        
                                        if (thirdColHasEmail && secondColHasOrg) {
                                            console.log('üéØ Structure expo d√©tect√©e (feuille Feuil1)...');
                                            // Structure: [vide, organisation, EMAIL, telephone, adresse]
                                            orgCol = 1; // Organisation en colonne 2
                                            emailCol = 2; // Email en colonne 3
                                            console.log(`üéØ Feuil1 positions fixes: Organisation=${orgCol}, Email=${emailCol}`);
                                        } else {
                                            console.log('‚ùå Structure expo non d√©tect√©e, utilisation colonnes par d√©faut (0,1)');
                                        }
                                    } else {
                                        console.log('‚ùå Structure expo non d√©tect√©e, utilisation colonnes par d√©faut (0,1)');
                                    }
                                } else {
                                    console.log('‚ùå Fichier trop court, utilisation colonnes par d√©faut (0,1)');
                                }
                                
                                console.log(`üéØ Colonnes finales d√©tect√©es: Organisation=${orgCol}, Email=${emailCol}`);
                                
                                // SOLUTION DE SECOURS: Scanner toutes les colonnes pour trouver les emails
                                console.log('\nüö® SOLUTION DE SECOURS: Scan complet des colonnes...');
                                let foundEmails = false;
                                let bestEmailCol = -1;
                                let bestOrgCol = -1;
                                let maxEmails = 0;
                                
                                // DIAGNOSTIC ULTRA-PROFOND: Montrer le contenu exact des cellules
                                console.log('\nüîç DIAGNOSTIC ULTRA-PROFOND - Contenu exact des cellules:');
                                console.log('='.repeat(80));
                                
                                rawData.slice(0, 10).forEach((row, rowIndex) => {
                                    console.log(`\n--- LIGNE ${rowIndex + 1} ---`);
                                    row.forEach((cell, colIndex) => {
                                        const cellStr = String(cell || '').trim();
                                        console.log(`  [${rowIndex + 1},${colIndex}] "${cellStr}"`);
                                        console.log(`    ‚Üí Longueur: ${cellStr.length}`);
                                        console.log(`    ‚Üí Type: ${typeof cell}`);
                                        console.log(`    ‚Üí Contient @: ${cellStr.includes('@')}`);
                                        console.log(`    ‚Üí Est email valide: ${/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cellStr)}`);
                                        
                                        if (cellStr.includes('@')) {
                                            console.log(`    ‚úÖ CONTIENT UN @: "${cellStr}"`);
                                        }
                                    });
                                });
                                
                                // Scanner chaque colonne pour voir o√π sont les emails
                                for (let col = 0; col < 10; col++) {
                                    let emailCount = 0;
                                    let orgCount = 0;
                                    let emailExamples = [];
                                    
                                    rawData.slice(0, 50).forEach(row => {
                                        const cell = String(row[col] || '').trim();
                                        if (cell.includes('@') && cell.length > 5) {
                                            emailCount++;
                                            if (emailExamples.length < 3) {
                                                emailExamples.push(cell);
                                            }
                                        } else if (cell.length > 3 && !cell.includes('@')) {
                                            orgCount++;
                                        }
                                    });
                                    
                                    console.log(`üìä Colonne ${col}: ${emailCount} emails, ${orgCount} organisations`);
                                    if (emailExamples.length > 0) {
                                        console.log(`   Exemples d'emails trouv√©s:`, emailExamples);
                                    }
                                    
                                    if (emailCount > maxEmails) {
                                        maxEmails = emailCount;
                                        bestEmailCol = col;
                                        foundEmails = true;
                                    }
                                }
                                
                                if (foundEmails && maxEmails > 0) {
                                    console.log(`üéØ SOLUTION DE SECOURS: ${maxEmails} emails trouv√©s dans la colonne ${bestEmailCol} !`);
                                    emailCol = bestEmailCol;
                                    orgCol = (bestEmailCol === 1) ? 0 : 1; // Choisir une autre colonne pour l'organisation
                                    console.log(`üîÑ Colonnes corrig√©es: Organisation=${orgCol}, Email=${emailCol}`);
                                } else {
                                    console.log('‚ùå SOLUTION DE SECOURS: Aucun email trouv√© dans aucune colonne');
                                    console.log('\nüö® ANALYSE CRITIQUE:');
                                    console.log('‚Üí Le fichier ne contient aucun symbole @ dans les 50 premi√®res lignes');
                                    console.log('‚Üí Possible que les emails soient plus loin dans le fichier');
                                    console.log('‚Üí Possible que les emails soient dans un format non reconnu');
                                    
                                    // SOLUTION DE FORCE BRUTE: Scanner tout le fichier
                                    console.log('\nüî• SOLUTION DE FORCE BRUTE: Scan complet du fichier...');
                                    let allEmails = [];
                                    let allOrgs = [];
                                    let emailPositions = [];
                                    
                                    // Scanner TOUTES les cellules du fichier
                                    rawData.forEach((row, rowIndex) => {
                                        row.forEach((cell, colIndex) => {
                                            const cellStr = String(cell || '').trim();
                                            
                                            // Chercher les emails dans TOUTES les cellules
                                            if (cellStr.includes('@') && cellStr.length > 5 && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cellStr)) {
                                                allEmails.push({
                                                    email: cellStr,
                                                    row: rowIndex,
                                                    col: colIndex
                                                });
                                                emailPositions.push({row: rowIndex, col: colIndex});
                                                
                                                if (allEmails.length <= 5) {
                                                    console.log(`‚úÖ EMAIL TROUV√â en [${rowIndex},${colIndex}]: "${cellStr}"`);
                                                }
                                            }
                                            
                                            // Chercher les organisations (texte long sans @)
                                            if (cellStr.length > 10 && !cellStr.includes('@') && !cellStr.match(/^\d+$/)) {
                                                allOrgs.push({
                                                    org: cellStr,
                                                    row: rowIndex,
                                                    col: colIndex
                                                });
                                            }
                                        });
                                    });
                                    
                                    console.log(`\nüî• R√âSULTATS FORCE BRUTE:`);
                                    console.log(`‚Üí Total emails trouv√©s: ${allEmails.length}`);
                                    console.log(`‚Üí Total organisations trouv√©es: ${allOrgs.length}`);
                                    
                                    if (allEmails.length > 0) {
                                        console.log(`\nüéØ FORCE BRUTE: ${allEmails.length} emails trouv√©s dans le fichier !`);
                                        
                                        // Analyser les positions des emails pour trouver la meilleure colonne
                                        const colCounts = {};
                                        emailPositions.forEach(pos => {
                                            colCounts[pos.col] = (colCounts[pos.col] || 0) + 1;
                                        });
                                        
                                        let bestCol = -1;
                                        let maxCount = 0;
                                        for (const [col, count] of Object.entries(colCounts)) {
                                            console.log(`‚Üí Colonne ${col}: ${count} emails`);
                                            if (count > maxCount) {
                                                maxCount = count;
                                                bestCol = parseInt(col);
                                            }
                                        }
                                        
                                        console.log(`üéØ Meilleure colonne email: ${bestCol} avec ${maxCount} emails`);
                                        
                                        // Choisir une colonne pour l'organisation (proche de la colonne email)
                                        let orgCol = bestCol - 1;
                                        if (orgCol < 0) orgCol = bestCol + 1;
                                        
                                        emailCol = bestCol;
                                        foundEmails = true;
                                        
                                        console.log(`üîÑ Colonnes force brute: Organisation=${orgCol}, Email=${emailCol}`);
                                        
                                        // Recr√©er les donn√©es avec les bonnes colonnes
                                        data = rawData.map((row, index) => {
                                            const organisation = String(row[orgCol] || '').trim();
                                            const email = String(row[emailCol] || '').trim();
                                            
                                            if (index < 5) {
                                                console.log(`üîÑ Ligne ${index + 1} force brute:`, {
                                                    organisation,
                                                    email
                                                });
                                            }
                                            
                                            return { organisation, email };
                                        }).filter(item => item.organisation || item.email);
                                        
                                        console.log(`üéØ Force brute: ${data.length} contacts cr√©√©s`);
                                    } else {
                                        console.log('‚ùå FORCE BRUTE: Aucun email trouv√© nulle part dans le fichier');
                                        console.log('\nüö® DIAGNOSTIC FINAL:');
                                        console.log('‚Üí Le fichier ne contient AUCUN email valide');
                                        console.log('‚Üí V√©rifiez que votre fichier contient bien des adresses email');
                                        console.log('‚Üí V√©rifiez le format des emails (exemple@domaine.com)');
                                    }
                                }
                                
                                // Utiliser les colonnes d√©tect√©es
                                console.log('\nüîÑ UTILISATION DES COLONNES D√âTECT√âES:');
                                console.log(`‚Üí Organisation colonne: ${orgCol}`);
                                console.log(`‚Üí Email colonne: ${emailCol}`);
                                
                                // V√©rifier si on a les bonnes colonnes
                                if (rawData.length > 3) {
                                    console.log('\nüîç V√âRIFICATION DES COLONNES:');
                                    const headerRow = rawData[2] || [];
                                    const firstDataRow = rawData[3] || [];
                                    
                                    console.log('üìã En-t√™tes (ligne 3):', headerRow);
                                    console.log('üìç Premi√®res donn√©es (ligne 4):', firstDataRow);
                                    
                                    if (headerRow[orgCol]) {
                                        console.log(`üìä Colonne Organisation (${orgCol}): "${headerRow[orgCol]}"`);
                                    }
                                    if (headerRow[emailCol]) {
                                        console.log(`üìä Colonne Email (${emailCol}): "${headerRow[emailCol]}"`);
                                    }
                                    
                                    // V√©rifier si les colonnes sont invers√©es
                                    const orgHeader = String(headerRow[orgCol] || '').toLowerCase();
                                    const emailHeader = String(headerRow[emailCol] || '').toLowerCase();
                                    
                                    console.log(`\nüîç Analyse des en-t√™tes:`);
                                    console.log(`‚Üí En-t√™te Organisation: "${orgHeader}"`);
                                    console.log(`‚Üí En-t√™te Email: "${emailHeader}"`);
                                    
                                    if (orgHeader.includes('email') || orgHeader.includes('mail')) {
                                        console.log('‚ùå ERREUR: Les colonnes sont invers√©es ! Organisation contient "email"');
                                        // Inverser les colonnes
                                        const temp = orgCol;
                                        orgCol = emailCol;
                                        emailCol = temp;
                                        console.log(`üîÑ Colonnes invers√©es: Organisation=${orgCol}, Email=${emailCol}`);
                                    }
                                    
                                    if (emailHeader.includes('organisation') || emailHeader.includes('nom')) {
                                        console.log('‚ùå ERREUR: Les colonnes sont invers√©es ! Email contient "organisation"');
                                        // Inverser les colonnes
                                        const temp = orgCol;
                                        orgCol = emailCol;
                                        emailCol = temp;
                                        console.log(`üîÑ Colonnes invers√©es: Organisation=${orgCol}, Email=${emailCol}`);
                                    }
                                }
                                
                                data = rawData.map((row, index) => {
                                    const organisation = String(row[orgCol] || '').trim();
                                    const email = String(row[emailCol] || '').trim();
                                    
                                    // Debug des 10 premi√®res lignes
                                    if (index < 10) {
                                        console.log(`üîÑ Ligne ${index + 1} restructur√©e:`, {
                                            organisation,
                                            email,
                                            originalRow: row
                                        });
                                    }
                                    
                                    return { organisation, email };
                                }).filter(item => item.organisation || item.email);
                                
                                console.log('üìã Donn√©es apr√®s restructuration:', data.slice(0, 10));
                                
                                // Analyse statistique compl√®te
                                console.log('\nüìà ANALYSE STATISTIQUE COMPL√àTE:');
                                let totalCells = 0;
                                let nonEmptyCells = 0;
                                let emailCells = 0;
                                let potentialOrgCells = 0;
                                let emptyCells = 0;
                                
                                rawData.forEach((row, rowIndex) => {
                                    row.forEach((cell, colIndex) => {
                                        totalCells++;
                                        const cellStr = String(cell || '').trim();
                                        
                                        if (cellStr.length === 0) {
                                            emptyCells++;
                                        } else {
                                            nonEmptyCells++;
                                            
                                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                            if (emailRegex.test(cellStr)) {
                                                emailCells++;
                                            } else if (cellStr.includes('@')) {
                                                // Contient @ mais pas un email valide
                                            } else if (cellStr.length > 2) {
                                                potentialOrgCells++;
                                            }
                                        }
                                    });
                                });
                                
                                console.log(`‚Üí Total cellules analys√©es: ${totalCells}`);
                                console.log(`‚Üí Cellules non vides: ${nonEmptyCells}`);
                                console.log(`‚Üí Cellules vides: ${emptyCells}`);
                                console.log(`‚Üí Emails valides: ${emailCells}`);
                                console.log(`‚Üí Entreprises potentielles: ${potentialOrgCells}`);
                                console.log(`‚Üí Pourcentage d'emails: ${((emailCells / totalCells) * 100).toFixed(2)}%`);
                                console.log(`‚Üí Pourcentage d'entreprises: ${((potentialOrgCells / totalCells) * 100).toFixed(2)}%`);
                                
                                if (emailCells === 0 && potentialOrgCells === 0) {
                                    console.log('\n‚ùå PROBL√àME CRITIQUE: Aucune donn√©e exploitable trouv√©e!');
                                    console.log('üîç Causes possibles:');
                                    console.log('   ‚Ä¢ Fichier vide ou prot√©g√©');
                                    console.log('   ‚Ä¢ Donn√©es dans des formats non reconnus');
                                    console.log('   ‚Ä¢ Feuille de calcul incorrecte');
                                    console.log('   ‚Ä¢ Encodage des caract√®res');
                                } else if (emailCells === 0) {
                                    console.log('\n‚ö†Ô∏è PROBL√àME: Aucun email valide trouv√©!');
                                    console.log('üîç V√©rifiez le format des emails dans votre fichier Excel');
                                } else {
                                    console.log('\n‚úÖ SUCC√àS: Donn√©es exploitables trouv√©es!');
                                }
                                
                                console.log('\n' + '='.repeat(80));
                                
                                // MODE D√âBOGAGE EXTR√äME - Analyse caract√®re par caract√®re
                                console.log('üîç D√âBOGAGE EXTR√äME - CONTENU EXACT DU FICHIER');
                                console.log('='.repeat(80));
                                console.log('üìã STRUCTURE COMPL√àTE DU FICHIER:');
                                console.log(`‚Üí Nombre total de lignes: ${rawData.length}`);
                                console.log(`‚Üí Nombre de colonnes par ligne: ${rawData[0] ? rawData[0].length : 'inconnu'}`);
                                
                                // Analyser les 10 premi√®res lignes en d√©tail
                                console.log('\nüìç ANALYSE D√âTAILL√âE (10 premi√®res lignes):');
                                rawData.slice(0, 10).forEach((row, index) => {
                                    console.log(`\n--- LIGNE ${index + 1} ---`);
                                    console.log(`Brut:`, JSON.stringify(row));
                                    
                                    row.forEach((cell, colIndex) => {
                                        const cellStr = String(cell || '').trim();
                                        console.log(`  Colonne ${colIndex}: "${cellStr}"`);
                                        console.log(`    ‚Üí Longueur: ${cellStr.length}`);
                                        console.log(`    ‚Üí Contient @: ${cellStr.includes('@')}`);
                                        console.log(`    ‚Üí Contient espace: ${cellStr.includes(' ')}`);
                                        console.log(`    ‚Üí Caract√®res sp√©ciaux: ${/[^\w\s@.-]/.test(cellStr) ? 'OUI' : 'NON'}`);
                                        
                                        // V√©rifier si √ßa ressemble √† un email
                                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                        const isEmail = emailRegex.test(cellStr);
                                        console.log(`    ‚Üí Est un email: ${isEmail}`);
                                        
                                        if (isEmail) {
                                            console.log(`    ‚úÖ EMAIL VALIDE TROUV√â: "${cellStr}"`);
                                        } else if (cellStr.includes('@')) {
                                            console.log(`    ‚ö†Ô∏è CONTIENT @ MAIS INVALIDE: "${cellStr}"`);
                                        }
                                    });
                                });
                                
                                // Chercher tous les emails dans tout le fichier
                                console.log('\nüîç RECHERCHE GLOBALE DES EMAILS:');
                                let totalEmailsFound = 0;
                                let allEmails = [];
                                
                                rawData.forEach((row, rowIndex) => {
                                    row.forEach((cell, colIndex) => {
                                        const cellStr = String(cell || '').trim();
                                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                        
                                        if (emailRegex.test(cellStr)) {
                                            totalEmailsFound++;
                                            allEmails.push({
                                                ligne: rowIndex + 1,
                                                colonne: colIndex,
                                                email: cellStr
                                            });
                                            console.log(`‚úÖ EMAIL TROUV√â - Ligne ${rowIndex + 1}, Colonne ${colIndex}: "${cellStr}"`);
                                        }
                                    });
                                });
                                
                                console.log(`\nüìä R√âSULTAT DE LA RECHERCHE:`);
                                console.log(`‚Üí Total d'emails valides trouv√©s: ${totalEmailsFound}`);
                                console.log(`‚Üí Pourcentage: ${((totalEmailsFound / rawData.length) * 100).toFixed(2)}%`);
                                
                                if (allEmails.length > 0) {
                                    console.log(`‚Üí Exemples d'emails trouv√©s:`, allEmails.slice(0, 5).map(e => e.email));
                                } else {
                                    console.log(`‚ùå AUCUN EMAIL VALIDE TROUV√â DANS TOUT LE FICHIER!`);
                                    
                                    // Montrer ce qui contient @ mais n'est pas valide
                                    console.log(`\n‚ö†Ô∏è CONTENANT @ MAIS INVALIDES:`);
                                    let invalidEmails = 0;
                                    rawData.slice(0, 20).forEach((row, rowIndex) => {
                                        row.forEach((cell, colIndex) => {
                                            const cellStr = String(cell || '').trim();
                                            if (cellStr.includes('@') && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cellStr)) {
                                                invalidEmails++;
                                                console.log(`   Ligne ${rowIndex + 1}, Colonne ${colIndex}: "${cellStr}"`);
                                            }
                                        });
                                    });
                                    
                                    if (invalidEmails === 0) {
                                        console.log(`   Aucun contenu avec @ trouv√© dans les 20 premi√®res lignes`);
                                    }
                                }
                                
                                console.log('\n' + '='.repeat(80));
                                
                                // MODE D√âBOGAGE ULTRA-D√âTAILL√â
                                console.log('üîç ANALYSE COMPL√àTE DU FICHIER EXCEL');
                                console.log('üìä Donn√©es brutes compl√®tes (premi√®res 20 lignes):');
                                rawData.slice(0, 20).forEach((row, index) => {
                                    console.log(`üìç Ligne ${index + 1}:`, row);
                                    console.log(`   ‚Üí Colonne 0: "${row[0] || '(vide)'}"`);
                                    console.log(`   ‚Üí Colonne 1: "${row[1] || '(vide)'}"`);
                                    console.log(`   ‚Üí Colonne 2: "${row[2] || '(vide)'}"`);
                                    console.log(`   ‚Üí Colonne 3: "${row[3] || '(vide)'}"`);
                                    console.log(`   ‚Üí Total colonnes: ${row.length}`);
                                });
                                
                                // Analyser la structure des colonnes
                                console.log('üîç ANALYSE DE LA STRUCTURE DES COLONNES');
                                const columnAnalysis = {
                                    col0: { data: [], hasEmails: 0, hasOrgs: 0 },
                                    col1: { data: [], hasEmails: 0, hasOrgs: 0 },
                                    col2: { data: [], hasEmails: 0, hasOrgs: 0 },
                                    col3: { data: [], hasEmails: 0, hasOrgs: 0 }
                                };
                                
                                rawData.slice(0, 50).forEach((row, index) => {
                                    [0, 1, 2, 3].forEach(colIndex => {
                                        const cellData = (row[colIndex] || '').trim();
                                        if (cellData) {
                                            columnAnalysis[`col${colIndex}`].data.push(cellData);
                                            
                                            // V√©rifier si c'est un email
                                            if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cellData)) {
                                                columnAnalysis[`col${colIndex}`].hasEmails++;
                                            }
                                            // V√©rifier si √ßa ressemble √† une organisation (pas d'@, longueur > 2)
                                            else if (!cellData.includes('@') && cellData.length > 2) {
                                                columnAnalysis[`col${colIndex}`].hasOrgs++;
                                            }
                                        }
                                    });
                                });
                                
                                console.log('üìä Analyse par colonne:');
                                Object.entries(columnAnalysis).forEach(([colName, analysis]) => {
                                    console.log(`${colName}:`);
                                    console.log(`   ‚Ä¢ Total donn√©es: ${analysis.data.length}`);
                                    console.log(`   ‚Ä¢ Emails trouv√©s: ${analysis.hasEmails}`);
                                    console.log(`   ‚Ä¢ Organisations: ${analysis.hasOrgs}`);
                                    console.log(`   ‚Ä¢ Exemples:`, analysis.data.slice(0, 3));
                                });
                                
                                // D√©tecter automatiquement la meilleure structure
                                console.log('ü§ñ D√âTECTION AUTOMATIQUE DE LA STRUCTURE');
                                let bestStructure = { orgCol: 0, emailCol: 1, confidence: 0 };
                                
                                // Tester toutes les combinaisons possibles
                                for (let orgCol = 0; orgCol <= 3; orgCol++) {
                                    for (let emailCol = 0; emailCol <= 3; emailCol++) {
                                        if (orgCol !== emailCol) {
                                            const orgData = columnAnalysis[`col${orgCol}`];
                                            const emailData = columnAnalysis[`col${emailCol}`];
                                            
                                            // Calculer un score de confiance
                                            const confidence = (orgData.hasOrgs * 2) + (emailData.hasEmails * 3);
                                            
                                            console.log(`   Test ${orgCol}->${emailCol}: confiance=${confidence} (orgs:${orgData.hasOrgs}, emails:${emailData.hasEmails})`);
                                            
                                            if (confidence > bestStructure.confidence) {
                                                bestStructure = { orgCol, emailCol, confidence };
                                            }
                                        }
                                    }
                                }
                                
                                console.log(`üéØ MEILLEURE STRUCTURE D√âTECT√âE:`);
                                console.log(`   ‚Ä¢ Organisation: Colonne ${bestStructure.orgCol}`);
                                console.log(`   ‚Ä¢ Email: Colonne ${bestStructure.emailCol}`);
                                console.log(`   ‚Ä¢ Confiance: ${bestStructure.confidence}`);
                                
                                // Utiliser la meilleure structure d√©tect√©e
                                data = rawData.map((row, index) => {
                                    const organisation = (row[bestStructure.orgCol] || '').trim();
                                    const email = (row[bestStructure.emailCol] || '').trim();
                                    
                                    // Debug des 10 premi√®res lignes avec la nouvelle structure
                                    if (index < 10) {
                                        console.log(`üîÑ Ligne ${index + 1} restructur√©e:`, {
                                            organisation,
                                            email,
                                            originalRow: row
                                        });
                                    }
                                    
                                    return { organisation, email };
                                }).filter(item => item.organisation || item.email);
                                
                                console.log('üìã Donn√©es apr√®s restructuration:', data.slice(0, 10));
                                
                                // CORRECTION FINALE GARANTIE - S'EX√âCUTE EN DERNIER
                                console.log('\nüîß CORRECTION FINALE GARANTIE:');
                                console.log('‚Üí V√©rification et correction des colonnes invers√©es...');
                                
                                // Analyser les en-t√™tes r√©els
                                if (rawData.length > 1) {
                                    const headerRow = rawData[0] || []; // LIGNE 1 (pas ligne 3)
                                    console.log('üìã En-t√™tes r√©els (ligne 1):', headerRow);
                                    
                                    // Chercher la vraie colonne E-MAIL
                                    let realEmailCol = -1;
                                    let realOrgCol = -1;
                                    
                                    headerRow.forEach((header, index) => {
                                        const headerStr = String(header || '').toLowerCase();
                                        if (headerStr.includes('e-mail') || headerStr.includes('email') || headerStr.includes('mail')) {
                                            realEmailCol = index;
                                            console.log(`‚úÖ Colonne Email trouv√©e: ${index} -> "${header}"`);
                                        } else if (headerStr.includes('organisation') || headerStr.includes('nom')) {
                                            realOrgCol = index;
                                            console.log(`‚úÖ Colonne Organisation trouv√©e: ${index} -> "${header}"`);
                                        }
                                    });
                                    
                                    // Si on a trouv√© les bonnes colonnes, recr√©er les donn√©es
                                    if (realEmailCol !== -1 && realOrgCol !== -1) {
                                        console.log(`üéØ Colonnes correctes trouv√©es: Organisation=${realOrgCol}, Email=${realEmailCol}`);
                                        
                                        // SOLUTION COMPL√àTE: Scanner TOUTES les lignes pour trouver les emails
                                        console.log('\nüîç SCAN COMPLET: Recherche de TOUS les emails dans tout le fichier...');
                                        
                                        let allValidContacts = [];
                                        let totalLines = rawData.length;
                                        let emailsFound = 0;
                                        
                                        rawData.forEach((row, index) => {
                                            const organisation = String(row[realOrgCol] || '').trim();
                                            const email = String(row[realEmailCol] || '').trim();
                                            
                                            // V√©rifier si c'est un email valide
                                            const hasAt = email.includes('@');
                                            const hasDomain = email.includes('.');
                                            const isValidEmail = hasAt && hasDomain && email.length > 5;
                                            
                                            if (isValidEmail) {
                                                allValidContacts.push({ organisation, email });
                                                emailsFound++;
                                                
                                                // Afficher les 10 premiers emails trouv√©s
                                                if (emailsFound <= 10) {
                                                    console.log(`‚úÖ Email ${emailsFound}: "${email}" (${organisation || 'Pas d\'organisation'})`);
                                                }
                                            }
                                        });
                                        
                                        console.log(`\nüéØ R√âSULTATS DU SCAN COMPLET:`);
                                        console.log(`‚Üí Total lignes scann√©es: ${totalLines}`);
                                        console.log(`‚Üí Emails valides trouv√©s: ${emailsFound}`);
                                        console.log(`‚Üí Contacts cr√©√©s: ${allValidContacts.length}`);
                                        
                                        // Utiliser TOUS les contacts trouv√©s
                                        data = allValidContacts;
                                        
                                        console.log(`üéØ Donn√©es finales compl√®tes: ${data.length} contacts`);
                                        
                                        // Afficher les 10 premiers contacts finaux
                                        console.log('\nüìã 10 premiers contacts finaux:');
                                        data.slice(0, 10).forEach((contact, index) => {
                                            console.log(`${index + 1}. ${contact.organisation} | ${contact.email}`);
                                        });
                                    } else {
                                        console.log('‚ùå Colonnes E-MAIL/ORGANISATION non trouv√©es dans les en-t√™tes');
                                    }
                                }
                                
                            } catch (excelError) {
                                console.error('‚ùå Erreur parsing Excel:', excelError);
                                reject(new Error('Erreur lors de la lecture du fichier Excel: ' + excelError.message));
                                return;
                            }
                        } else {
                            reject(new Error('Format de fichier non support√©. Utilisez CSV ou Excel (.xlsx, .xls)'));
                            return;
                        }
                        
                        // D√©tection automatique des colonnes invers√©es
                        console.log('üîç D√©tection des colonnes...');
                        
                        // Analyser les 10 premi√®res lignes pour d√©terminer la structure
                        const sampleRows = data.slice(0, 10);
                        let emailInCol1 = 0;
                        let emailInCol2 = 0;
                        let orgInCol1 = 0;
                        let orgInCol2 = 0;
                        
                        sampleRows.forEach(row => {
                            const col1 = (row.organisation || '').trim();
                            const col2 = (row.email || '').trim();
                            
                            // V√©rifier si col1 ressemble √† un email
                            if (/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(col1)) {
                                emailInCol1++;
                            }
                            // V√©rifier si col2 ressemble √† un email
                            if (/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(col2)) {
                                emailInCol2++;
                            }
                            // V√©rifier si col1 ressemble √† une organisation (contient des lettres, pas d'@)
                            if (col1 && !col1.includes('@') && col1.length > 2) {
                                orgInCol1++;
                            }
                            // V√©rifier si col2 ressemble √† une organisation
                            if (col2 && !col2.includes('@') && col2.length > 2) {
                                orgInCol2++;
                            }
                        });
                        
                        console.log('üìä Analyse des colonnes:', {
                            emailInCol1, emailInCol2, orgInCol1, orgInCol2,
                            sampleRows: sampleRows.slice(0, 3)
                        });
                        
                        // D√©terminer si les colonnes sont invers√©es
                        let columnsInverted = false;
                        if (emailInCol1 > emailInCol2 && orgInCol2 > orgInCol1) {
                            columnsInverted = true;
                            console.log('üîÑ Colonnes invers√©es d√©tect√©es - Inversion en cours...');
                            
                            // Inverser les colonnes pour toutes les donn√©es
                            data = data.map(row => ({
                                organisation: row.email || '',
                                email: row.organisation || ''
                            }));
                            
                            console.log('üìã Donn√©es apr√®s inversion:', data.slice(0, 3));
                        } else {
                            console.log('‚úÖ Structure des colonnes correcte');
                        }
                        
                        // Validation et filtrage des emails
                        console.log('üîç Validation des contacts...');
                        
                        // MODE D√âBOGAGE: Afficher tous les emails trouv√©s (m√™me invalides)
                        const allEmails = data.map(row => ({
                            original: row,
                            email: (row.email || '').trim(),
                            organisation: (row.organisation || '').trim(),
                            // Test avec plusieurs regex plus permissives
                            looksLikeEmailStrict: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test((row.email || '').trim()),
                            looksLikeEmailFlexible: /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((row.email || '').trim()),
                            hasAtSymbol: (row.email || '').includes('@'),
                            hasDomain: (row.email || '').split('@').length === 2 && (row.email || '').split('@')[1].includes('.')
                        }));
                        
                        console.log('üìß Analyse compl√®te des emails trouv√©s:', allEmails.slice(0, 20));
                        
                        // Compter les types de donn√©es avec les nouvelles validations
                        const emailPatternsStrict = allEmails.filter(item => item.looksLikeEmailStrict);
                        const emailPatternsFlexible = allEmails.filter(item => item.looksLikeEmailFlexible);
                        const nonEmailPatterns = allEmails.filter(item => !item.looksLikeEmailFlexible && item.email);
                        const hasAtSymbol = allEmails.filter(item => item.hasAtSymbol);
                        
                        console.log('üìä Statistiques d√©taill√©es:', {
                            totalLignes: data.length,
                            emailsValidesStrict: emailPatternsStrict.length,
                            emailsValidesFlexible: emailPatternsFlexible.length,
                            nonEmails: nonEmailPatterns.length,
                            avecSymboleAt: hasAtSymbol.length,
                            lignesVides: data.filter(row => !row.email && !row.organisation).length,
                            exemplesEmailsValides: emailPatternsFlexible.slice(0, 5).map(e => e.email),
                            exemplesNonEmails: nonEmailPatterns.slice(0, 5).map(e => e.email),
                            exemplesAvecAt: hasAtSymbol.slice(0, 5).map(e => e.email)
                        });
                        
                        // Utiliser une validation plus flexible
                        let validContacts = data.filter(row => {
                            const email = (row.email || '').trim();
                            const organisation = (row.organisation || '').trim();
                            
                            // Validation email flexible - accepte plus de formats
                            const flexibleEmailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            const isValidEmail = flexibleEmailRegex.test(email);
                            
                            if (isValidEmail) {
                                console.log('‚úÖ Contact valide (flexible):', { organisation, email });
                                return true;
                            } else {
                                console.log('‚ùå Contact invalide:', { 
                                    organisation, 
                                    email, 
                                    reason: !isValidEmail ? 'email invalide' : 'email valide accept√© (organisation optionnelle)',
                                    hasAt: email.includes('@'),
                                    hasDomain: email.split('@').length === 2,
                                    emailLength: email.length,
                                    columnsInverted 
                                });
                                return false;
                            }
                        });
                        
                        console.log('üìä R√©sultat final:', {
                            totalRows: data.length,
                            validContacts: validContacts.length,
                            invalidContacts: data.length - validContacts.length,
                            columnsInverted,
                            validationMode: 'flexible'
                        });
                        
                        // D√âBOGAGE DES R√âSULTATS FINAUX
                        console.log('üéØ R√âSULTATS FINAUX DU TRAITEMENT:');
                        console.log('='.repeat(60));
                        console.log(`üìä Total de lignes lues: ${data.length}`);
                        console.log(`‚úÖ Contacts valides: ${validContacts.length}`);
                        console.log(`‚ùå Contacts invalides: ${data.length - validContacts.length}`);
                        
                        if (validContacts.length > 0) {
                            console.log('\nüìã LISTE DES CONTACTS VALIDES TROUV√âS:');
                            validContacts.forEach((contact, index) => {
                                console.log(`${index + 1}. Organisation: "${contact.organisation}" | Email: "${contact.email}"`);
                            });
                        } else {
                            console.log('\n‚ùå AUCUN CONTACT VALIDE TROUV√â!');
                            console.log('\nüìã 10 PREMI√àRES LIGNES TRAIT√âES (pour diagnostic):');
                            data.slice(0, 10).forEach((row, index) => {
                                console.log(`${index + 1}. Organisation: "${row.organisation}" | Email: "${row.email}"`);
                                console.log(`   ‚Üí Email valide: ${/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(row.email)}`);
                                console.log(`   ‚Üí Organisation non vide: ${row.organisation.length > 0}`);
                            });
                        }
                        
                        console.log('\n' + '='.repeat(60));
                        
                        if (validContacts.length === 0) {
                            console.warn('‚ö†Ô∏è Aucun contact valide trouv√© dans le fichier');
                            console.log('üìã Exemples de donn√©es brutes:', data.slice(0, 5));
                            
                            // Message d'aide d√©taill√© selon le cas
                            if (columnsInverted) {
                                console.log('üí° Les colonnes ont √©t√© invers√©es automatiquement.');
                            }
                            
                            if (emailPatternsFlexible.length === 0) {
                                console.log('‚ùå PROBL√àME: Aucun email valide trouv√© m√™me avec validation flexible !');
                                console.log('üìã Analyse de votre fichier:');
                                console.log(`   ‚Ä¢ Total lignes: ${data.length}`);
                                console.log(`   ‚Ä¢ Avec symbole @: ${hasAtSymbol.length}`);
                                console.log(`   ‚Ä¢ Ressemblant √† des emails (strict): ${emailPatternsStrict.length}`);
                                console.log(`   ‚Ä¢ Ressemblant √† des emails (flexible): ${emailPatternsFlexible.length}`);
                                
                                if (hasAtSymbol.length > 0) {
                                    console.log('üîç Emails avec @ mais invalides:');
                                    hasAtSymbol.slice(0, 5).forEach(item => {
                                        console.log(`   ‚ùå "${item.email}" - probl√®me probable: format incomplet`);
                                    });
                                    console.log('');
                                    console.log('ÔøΩ CAUSES POSSIBLES:');
                                    console.log('   ‚Ä¢ Emails incomplets (ex: "contact@" ou "@domaine")');
                                    console.log('   ‚Ä¢ Espaces en d√©but/fin (ex: " email@domaine.com ")');
                                    console.log('   ‚Ä¢ Caract√®res sp√©ciaux non support√©s');
                                    console.log('   ‚Ä¢ Domaine manquant (ex: "contact@.com")');
                                } else {
                                    console.log('‚ùå Aucun symbole @ trouv√© dans votre fichier !');
                                    console.log('üìã Votre fichier contient probablement:');
                                    console.log('   ‚Ä¢ Des noms d\'entreprises sans emails');
                                    console.log('   ‚Ä¢ Des num√©ros de t√©l√©phone');
                                    console.log('   ‚Ä¢ Des adresses postales');
                                }
                            } else if (nonEmailPatterns.length > 0) {
                                console.log('‚ö†Ô∏è Certains ressemblent √† des emails mais ne sont pas valides:');
                                nonEmailPatterns.slice(0, 5).forEach(item => {
                                    console.log(`   ‚ùå "${item.email}" - format email incorrect`);
                                });
                            }
                        } else {
                            console.log(`üéâ SUCC√àS: ${validContacts.length} contacts valides trouv√©s !`);
                        }
                        
                        // üîß CORRECTION FINALE ABSOLUE - Juste avant le resolve
                        console.log('\nüîß CORRECTION FINALE ABSOLUE:');
                        console.log('‚Üí V√©rification que tous les emails sont inclus...');
                        
                        // Si on a rawData et qu'on a trouv√© les colonnes, reconstruire avec TOUS les emails
                        if (rawData && rawData.length > 1) {
                            const headerRow = rawData[0] || [];
                            console.log('üìã EN-T√äTES D√âTECT√âS:', headerRow);
                            let realEmailCol = -1;
                            let realOrgCol = -1;
                            
                            headerRow.forEach((header, index) => {
                                const headerStr = String(header || '').toLowerCase();
                                console.log(`   Colonne ${index}: "${header}" -> "${headerStr}"`);
                                if (headerStr.includes('e-mail') || headerStr.includes('email') || headerStr.includes('mail')) {
                                    realEmailCol = index;
                                    console.log(`‚úÖ Colonne EMAIL trouv√©e: index ${index}`);
                                } else if (headerStr.includes('nom de l\'organisation') || headerStr.includes('nom de organisation') || headerStr.includes('organisation')) {
                                    realOrgCol = index;
                                    console.log(`‚úÖ Colonne ORGANISATION trouv√©e: index ${index}`);
                                }
                            });
                            
                            if (realEmailCol !== -1) {
                                console.log(`üéØ Colonnes finales: Organisation=${realOrgCol}, Email=${realEmailCol}`);
                                
                                let allEmails = [];
                                rawData.forEach((row, index) => {
                                    const organisation = String(row[realOrgCol] || '').trim();
                                    const email = String(row[realEmailCol] || '').trim();
                                    
                                    const hasAt = email.includes('@');
                                    const hasDomain = email.includes('.');
                                    const isValidEmail = hasAt && hasDomain && email.length > 5;
                                    
                                    if (isValidEmail) {
                                        allEmails.push({ organisation, email });
                                        // Afficher les 3 premiers exemples
                                        if (allEmails.length <= 3) {
                                            console.log(`üìã Exemple ${allEmails.length}: "${organisation}" | "${email}"`);
                                        }
                                    }
                                });
                                
                                console.log(`üéØ TROUV√â: ${allEmails.length} emails au total (vs ${validContacts.length} contacts valides)`);
                                
                                if (allEmails.length > validContacts.length) {
                                    console.log(`üîÑ Remplacement de validContacts avec TOUS les emails trouv√©s...`);
                                    validContacts = allEmails;
                                    console.log(`üéâ NOUVEAU TOTAL: ${validContacts.length} contacts !`);
                                }
                            }
                        }
                        
                        resolve(validContacts);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur g√©n√©rale parsing:', error);
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('‚ùå Erreur lecture fichier:', error);
                    reject(new Error('Erreur lors de la lecture du fichier'));
                };
                
                // Choisir la m√©thode de lecture selon le type
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.readAsBinaryString(file);
                } else {
                    reject(new Error('Format de fichier non support√©'));
                }
            });
        }
        
        // Charger les contacts import√©s
        async function loadContacts() {
            // √âviter les chargements multiples
            if (isLoadingContacts) {
                console.log('‚è≥ Chargement des contacts d√©j√† en cours, annulation...');
                return;
            }
            
            isLoadingContacts = true;
            const list = document.getElementById('emailList');
            list.innerHTML = '<p style="text-align: center;">‚è≥ Chargement...</p>';
            
            try {
                console.log('üì• CHARGEMENT DES CONTACTS depuis /api/contacts...');
                const res = await apiFetch('/api/contacts');
                const data = await res.json();
                
                console.log('üìã DONN√âES RE√áUES du backend:', data);
                importedContacts = data.contacts || [];
                console.log(`üìä ${importedContacts.length} contacts charg√©s`);
                if (importedContacts.length > 0) {
                    console.log('üìã Premier contact re√ßu:', importedContacts[0]);
                    console.log('üìã D√©tails du premier contact:');
                    console.log('   - Organisation:', importedContacts[0].organisation);
                    console.log('   - Email:', importedContacts[0].email);
                    console.log('   - Keys:', Object.keys(importedContacts[0]));
                }
                
                // Mettre √† jour les stats
                document.getElementById('totalContacts').textContent = importedContacts.length;
                document.getElementById('maxEmails').textContent = importedContacts.filter(c => !c.sent).length;
                
                if (importedContacts.length === 0) {
                    console.log('‚ö†Ô∏è Aucun contact trouv√© dans le backend');
                    list.innerHTML = '<p style="text-align: center; color: #999;">Aucun contact import√©</p>';
                    return;
                }
                
                // Afficher les contacts
                const html = importedContacts.map(contact => `
                    <div class="email-item ${contact.sent ? 'sent' : ''}">
                        <div class="email-info">
                            <strong>${contact.organisation}</strong><br>
                            <small>${contact.email}</small>
                        </div>
                        <div class="email-status">
                            ${contact.sent ? '‚úÖ Envoy√©' : '‚è≥ En attente'}
                        </div>
                    </div>
                `).join('');
                
                console.log(`‚úÖ Affichage de ${importedContacts.length} contacts dans l'interface`);
                list.innerHTML = html;
                
                // Mettre √† jour les badges de navigation
                await updateNavBadges();
            } catch (error) {
                console.error('Erreur chargement contacts:', error);
                list.innerHTML = '<p style="text-align: center; color: #FF4757;">Erreur de chargement</p>';
            } finally {
                isLoadingContacts = false;
            }
        }
        
        // Vider tous les contacts
        async function clearAllContacts() {
            const confirmed = await showConfirmModal({
                title: 'üóëÔ∏è Suppression des contacts',
                emailsToSend: importedContacts.length,
                totalContacts: importedContacts.length,
                pendingContacts: importedContacts.filter(c => !c.sent).length,
                subject: 'Tous les contacts seront d√©finitivement supprim√©s'
            });
            if (!confirmed) return;
            
            try {
                await apiFetch('/api/contacts', { method: 'DELETE' });
                showAlert('‚úÖ Tous les contacts ont √©t√© supprim√©s', 'success');
                await loadContacts();
                await updateNavBadges(); // Mettre √† jour les badges apr√®s suppression
            } catch (error) {
                showAlert('‚ùå Erreur lors de la suppression', 'error');
            }
        }
        
        // Exporter les contacts
        function exportContacts() {
            window.location.href = '/api/export/contacts';
            showAlert('üì• Export des contacts en cours...', 'success');
        }
        
        // Envoyer un nombre personnalis√© d'emails
        async function sendCustomEmails() {
            const count = parseInt(document.getElementById('emailCount').value);
            if (!count || count < 1) {
                showAlert('‚ùå Entrez un nombre valide', 'error');
                return;
            }
            
            sendEmails(count);
        }
        
        // Envoyer les emails
        async function sendEmails(limit) {
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!subject || !message) {
                showAlert('‚ùå Remplissez le sujet et le message', 'error');
                return;
            }
            
            // R√©cup√©rer le nombre de contacts en attente
            const pendingContacts = importedContacts.filter(c => !c.sent).length;
            const totalContacts = importedContacts.length;
            const emailsToSend = Math.min(limit, pendingContacts);
            
            if (emailsToSend === 0) {
                showAlert('‚ùå Aucun contact √† envoyer', 'error');
                return;
            }
            
            // Afficher le popup personnalis√©
            const confirmed = await showConfirmModal({
                title: limit === 999999 ? 'üöÄ Envoi Massif' : 'üìß Envoi d\'Emails',
                emailsToSend: emailsToSend,
                totalContacts: totalContacts,
                pendingContacts: pendingContacts,
                subject: subject
            });
            
            if (!confirmed) return;
            
            showAlert('‚è≥ Envoi en cours...', 'success');
            
            try {
                const res = await apiFetch('/api/send-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, message, limit })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showAlert(`‚úÖ ${data.sent} emails envoy√©s avec succ√®s!`, 'success');
                    await loadContacts();
                    
                    // Mettre √† jour les badges avec les nouvelles statistiques
                    await updateNavBadges();
                    
                    // Mettre √† jour le widget de suivi s'il existe
                    if (typeof loadEmailTracking === 'function') {
                        loadEmailTracking();
                    }
                } else {
                    showAlert('‚ùå Erreur lors de l\'envoi', 'error');
                }
            } catch (e) {
                console.error('‚ùå Erreur envoi:', e);
                showAlert('‚ùå Erreur: ' + e.message, 'error');
            }
        }
        
        // Afficher une alerte
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Modal de confirmation
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.75);
                    backdrop-filter: blur(6px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                // Adapter l'ic√¥ne et le message selon le type d'action
                const isDeletion = options.title.includes('Suppression');
                const icon = isDeletion ? 'üóëÔ∏è' : (options.title.includes('Massif') ? 'üöÄ' : 'üìß');
                const mainMessage = isDeletion 
                    ? `Vous allez supprimer <strong>${options.emailsToSend}</strong> contacts`
                    : `Vous allez envoyer <strong>${options.emailsToSend}</strong> emails`;
                
                modal.innerHTML = `
                    <div style="background: linear-gradient(180deg, ${isDeletion ? '#2d1b1b' : '#2b2f3a'} 0%, ${isDeletion ? '#1f1414' : '#1f2430'} 100%); border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 12px 40px rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.04); text-align: center; color: #fff;">
                        <div style="font-size: 2.5em; margin-bottom: 15px;">${icon}</div>
                        <h3 style="margin-bottom: 15px; color: ${isDeletion ? '#ff6b6b' : '#fff'};">${options.title}</h3>
                        <p style="margin-bottom: 10px;">${mainMessage}</p>
                        ${isDeletion ? `
                            <p style="font-size: 0.9em; color: #ff9999; margin-bottom: 15px;">
                                ‚ö†Ô∏è Cette action est <strong>irr√©versible</strong>
                            </p>
                            ${options.pendingContacts > 0 ? `
                                <p style="font-size: 0.85em; color: #ffc107; margin-bottom: 20px;">
                                    üìß ${options.pendingContacts} emails non envoy√©s seront aussi supprim√©s
                                </p>
                            ` : ''}
                        ` : `
                            <p style="font-size: 0.9em; color: #cbd5e1; margin-bottom: 20px;">Sujet: ${options.subject}</p>
                        `}
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="cancelBtn" style="padding: 10px 20px; border: 1px solid ${isDeletion ? '#ff6b6b' : '#667eea'}; background: transparent; color: ${isDeletion ? '#ff6b6b' : '#667eea'}; border-radius: 6px; cursor: pointer;">Annuler</button>
                            <button id="confirmBtn" style="padding: 10px 20px; border: none; background: ${isDeletion ? '#ff4757' : '#667eea'}; color: white; border-radius: 6px; cursor: pointer;">${isDeletion ? 'Supprimer' : 'Confirmer'}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Ajouter les √©couteurs d'√©v√©nements
                modal.querySelector('#cancelBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
                
                modal.querySelector('#confirmBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
            });
        }
        
        // Tableau de bord de suivi en temps r√©el
        let dashboardInterval = null;
        
        async function loadDashboardStats() {
            try {
                const res = await apiFetch('/api/dashboard-stats');
                const data = await res.json();
                
                if (data.success) {
                    updateDashboardDisplay(data.stats);
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
            }
        }
        
        function updateDashboardDisplay(stats) {
            // Mettre √† jour les badges de navigation avec les stats temps r√©el
            const totalBadge = document.querySelector('[data-badge="total"]');
            const sentBadge = document.querySelector('[data-badge="sent"]');
            const pendingBadge = document.querySelector('[data-badge="pending"]');
            
            if (totalBadge) totalBadge.textContent = stats.totalContacts;
            if (sentBadge) sentBadge.textContent = stats.sentContacts;
            if (pendingBadge) pendingBadge.textContent = stats.pendingContacts;
            
            // Mettre √† jour les compteurs principaux
            document.getElementById('totalContacts').textContent = stats.totalContacts;
            document.getElementById('maxEmails').textContent = stats.pendingContacts;
            
            // Afficher les stats de suivi si l'√©l√©ment existe
            const trackingStats = document.getElementById('trackingStats');
            if (trackingStats) {
                trackingStats.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>üìß Emails Envoy√©s</h4>
                            <div class="stat-number">${stats.totalSent}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üëÅÔ∏è Emails Ouverts</h4>
                            <div class="stat-number">${stats.totalOpened}</div>
                            <div class="stat-rate">${stats.openRate}%</div>
                        </div>
                        <div class="stat-card">
                            <h4>üí¨ R√©ponses</h4>
                            <div class="stat-number">${stats.totalReplied}</div>
                        </div>
                        <div class="stat-card">
                            <h4>‚è∞ Derni√®re mise √† jour</h4>
                            <div class="stat-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                    
                    ${stats.recentOpens.length > 0 ? `
                        <div class="recent-activity">
                            <h4>üî• Ouvertures r√©centes</h4>
                            ${stats.recentOpens.map(open => `
                                <div class="activity-item">
                                    <strong>${open.email}</strong>
                                    <small>${open.organisation || ''}</small>
                                    <span class="activity-time">${new Date(open.openedAt).toLocaleTimeString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }
        }
        
        // D√©marrer le rafra√Æchissement automatique
        function startRealTimeUpdates() {
            // Charger les stats imm√©diatement
            loadDashboardStats();
            
            // Rafra√Æchir toutes les 30 secondes
            if (dashboardInterval) clearInterval(dashboardInterval);
            dashboardInterval = setInterval(loadDashboardStats, 30000);
            
            console.log('üîÑ Suivi temps r√©el d√©marr√© (rafra√Æchissement toutes les 30s)');
        }
        
        // Arr√™ter le rafra√Æchissement
        function stopRealTimeUpdates() {
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
                dashboardInterval = null;
                console.log('‚è∏Ô∏è Suivi temps r√©el arr√™t√©');
            }
        }

        // Charger les contacts au d√©marrage
        window.addEventListener('load', async () => {
            await loadContacts();
            await loadManualRecipients(); // Charger les destinataires manuels
            await updateNavBadges(); // Initialiser les badges au chargement
            
            // D√©marrer le suivi temps r√©el apr√®s 2 secondes
            setTimeout(() => {
                startRealTimeUpdates();
            }, 2000);
            
            // Rafra√Æchir les badges toutes les 30 secondes
            setInterval(async () => {
                await updateNavBadges();
            }, 30000);
        });
        
        // Widget de suivi des emails
        function createEmailTrackingWidget() {
            const widget = document.createElement('div');
            widget.id = 'emailTrackingWidget';
            widget.innerHTML = `
                <div class="tracking-widget" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0; border: 1px solid #e9ecef;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Suivi des Emails Envoy√©s</h3>
                    
                    <div class="tracking-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="totalSent">0</div>
                            <div style="color: #666; font-size: 14px;">Emails Envoy√©s</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalOpened">0</div>
                            <div style="color: #666; font-size: 14px;">Emails Ouverts</div>
                        </div>
                        <div class="stat-card" style="background: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="openRate">0%</div>
                            <div style="color: #666; font-size: 14px;">Taux d'Ouverture</div>
                        </div>
                    </div>
                    
                    <div class="tracking-list" style="background: white; border-radius: 6px; padding: 15px;">
                        <h4 style="margin-bottom: 10px; color: #333;">üìã Liste des Emails Suivis</h4>
                        <div id="trackingList" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: #999; text-align: center;">Chargement...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <small style="color: #666;">Derni√®re mise √† jour: <span id="lastUpdate">-</span></small>
                    </div>
                </div>
            `;
            
            return widget;
        }

        // Charger et afficher les donn√©es de suivi
        async function loadEmailTracking() {
            try {
                const res = await apiFetch('/api/dashboard-stats');
                const data = await res.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Mettre √† jour les compteurs
                    document.getElementById('totalSent').textContent = stats.totalSent || 0;
                    document.getElementById('totalOpened').textContent = stats.totalOpened || 0;
                    document.getElementById('openRate').textContent = (stats.openRate || 0) + '%';
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    
                    // Afficher la liste des emails
                    const trackingList = document.getElementById('trackingList');
                    if (stats.allTracking && stats.allTracking.length > 0) {
                        trackingList.innerHTML = stats.allTracking.map(item => `
                            <div class="tracking-item" style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.email}</strong>
                                    <br><small style="color: #666;">${item.organisation || 'Non sp√©cifi√©'}</small>
                                </div>
                                <div style="text-align: right;">
                                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 12px; background: ${item.opened ? '#28a745' : '#ffc107'}; color: white;">
                                        ${item.opened ? '‚úÖ Ouvert' : '‚è≥ En attente'}
                                    </span>
                                    <br><small style="color: #999;">
                                        Envoy√©: ${new Date(item.sentAt).toLocaleDateString()}
                                        ${item.openedAt ? `<br>Ouvert: ${new Date(item.openedAt).toLocaleDateString()}` : ''}
                                    </small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        trackingList.innerHTML = '<p style="color: #999; text-align: center;">Aucun email suivi pour le moment</p>';
                    }
                }
            } catch (error) {
                console.error('Erreur chargement suivi:', error);
                const trackingList = document.getElementById('trackingList');
                if (trackingList) {
                    trackingList.innerHTML = '<p style="color: #ff4757; text-align: center;">Erreur de chargement</p>';
                }
            }
        }

        // Initialiser le widget de suivi
        document.addEventListener('DOMContentLoaded', () => {
            // Ajouter le widget apr√®s la section des contacts
            const contactsSection = document.querySelector('.email-list');
            if (contactsSection) {
                const widget = createEmailTrackingWidget();
                contactsSection.parentNode.insertBefore(widget, contactsSection.nextSibling);
                
                // Charger les donn√©es initiales
                loadEmailTracking();
                
                // Rafra√Æchir toutes les 30 secondes
                setInterval(loadEmailTracking, 30000);
            }
        });
    </script>
</body>
</html>