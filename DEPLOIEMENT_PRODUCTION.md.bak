# üöÄ Guide de D√©ploiement Production

## üìã Pr√©requis

- VPS avec Ubuntu 20.04/22.04 (minimum 2GB RAM)
- Nom de domaine configur√©
- Acc√®s SSH root ou sudo

---

## 1Ô∏è‚É£ Pr√©paration du Serveur

### **Connexion SSH**

```bash
ssh root@votre-ip-serveur
```

### **Mise √† jour du syst√®me**

```bash
apt update && apt upgrade -y
```

### **Installation Node.js 20+**

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt install -y nodejs
node --version  # V√©rifier : v18.x ou plus
```

### **Installation PM2**

```bash
npm install -g pm2
pm2 --version
```

### **Installation Nginx**

```bash
apt install -y nginx
systemctl status nginx
```

### **Installation Certbot (SSL)**

```bash
apt install -y certbot python3-certbot-nginx
```

---

## 2Ô∏è‚É£ Configuration du Domaine

### **DNS**

Ajoutez ces enregistrements DNS :

```
Type    Nom                 Valeur
A       votredomaine.com    VOTRE_IP_SERVEUR
A       www                 VOTRE_IP_SERVEUR
```

**Attendez 5-10 minutes** pour la propagation DNS.

### **V√©rification**

```bash
ping votredomaine.com
# Doit r√©pondre avec votre IP
```

---

## 3Ô∏è‚É£ D√©ploiement de l'Application

### **Cr√©er un utilisateur d√©di√©**

```bash
adduser hyperemail
usermod -aG sudo hyperemail
su - hyperemail
```

### **Cloner ou transf√©rer l'application**

**Option A : Depuis votre machine locale**

```bash
# Sur votre machine locale
cd /Users/jamilaaitbouchnani/Downloads/HyperEmail-main
tar -czf hyperemail.tar.gz .
scp hyperemail.tar.gz hyperemail@votre-ip:/home/hyperemail/

# Sur le serveur
cd /home/hyperemail
tar -xzf hyperemail.tar.gz
rm hyperemail.tar.gz
```

**Option B : Depuis Git (si vous avez un repo)**

```bash
cd /home/hyperemail
git clone https://github.com/votre-repo/hyperemail.git
cd hyperemail
```

### **Installer les d√©pendances**

```bash
cd /home/hyperemail/hyperemail
npm install --production
```

---

## 4Ô∏è‚É£ Configuration de l'Application

### **Cr√©er le fichier .env**

```bash
cp env.production.example .env
nano .env
```

**Modifiez les valeurs :**

```env
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# Supabase
GOOGLE_APPLICATION_CREDENTIALS=/home/hyperemail/firebase-key.json

# SMTP - SendGrid (Recommand√©)
SMTP_SERVICE=sendgrid
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=VOTRE_CLE_API_SENDGRID
EMAIL_FROM=noreply@votredomaine.com
EMAIL_FROM_NAME=HyperEmail

# S√©curit√©
SESSION_SECRET=$(openssl rand -base64 32)
CORS_ORIGIN=https://votredomaine.com
```

**Sauvegardez** : Ctrl+O, Enter, Ctrl+X

### **Transf√©rer le fichier Supabase**

```bash
# Sur votre machine locale
scp ~/firebase-key.json hyperemail@votre-ip:/home/hyperemail/

# Sur le serveur
chmod 600 /home/hyperemail/firebase-key.json
```

### **Cr√©er le dossier logs**

```bash
mkdir -p /home/hyperemail/hyperemail/logs
```

---

## 5Ô∏è‚É£ Configuration PM2

### **D√©marrer l'application**

```bash
cd /home/hyperemail/hyperemail
pm2 start ecosystem.config.js --env production
```

### **V√©rifier le statut**

```bash
pm2 status
pm2 logs hyperemail
```

**Vous devriez voir :**
```
‚úÖ Supabase connect√©
‚úÖ SMTP: noreply@votredomaine.com
üöÄ Serveur: http://0.0.0.0:3000
```

### **Configurer le d√©marrage automatique**

```bash
pm2 startup
# Copier-coller la commande affich√©e

pm2 save
```

---

## 6Ô∏è‚É£ Configuration Nginx

### **Cr√©er la configuration**

```bash
sudo nano /etc/nginx/sites-available/hyperemail
```

**Copiez le contenu de `nginx.conf`** (remplacez `votredomaine.com`)

### **Activer le site**

```bash
sudo ln -s /etc/nginx/sites-available/hyperemail /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default  # Supprimer le site par d√©faut
```

### **Tester la configuration**

```bash
sudo nginx -t
```

**Si OK :**
```bash
sudo systemctl reload nginx
```

---

## 7Ô∏è‚É£ Configuration SSL (HTTPS)

### **Obtenir le certificat**

```bash
sudo certbot --nginx -d votredomaine.com -d www.votredomaine.com
```

**Suivez les instructions :**
1. Entrez votre email
2. Acceptez les conditions
3. Choisissez "2" pour rediriger HTTP vers HTTPS

### **V√©rification**

```bash
sudo certbot certificates
```

### **Renouvellement automatique**

```bash
sudo certbot renew --dry-run
```

Le renouvellement se fera automatiquement tous les 90 jours.

---

## 8Ô∏è‚É£ Configuration du Firewall

### **UFW (Firewall)**

```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
sudo ufw status
```

---

## 9Ô∏è‚É£ V√©rification Finale

### **Test de l'application**

1. **Ouvrez** : https://votredomaine.com
2. **Vous devriez voir** : Page de connexion HyperEmail
3. **Connectez-vous** avec les credentials
4. **Testez** le scraping

### **V√©rifier les logs**

```bash
# Logs PM2
pm2 logs hyperemail

# Logs Nginx
sudo tail -f /var/log/nginx/hyperemail-access.log
sudo tail -f /var/log/nginx/hyperemail-error.log

# Logs syst√®me
journalctl -u nginx -f
```

---

## üîß Commandes Utiles

### **PM2**

```bash
pm2 restart hyperemail    # Red√©marrer
pm2 stop hyperemail       # Arr√™ter
pm2 delete hyperemail     # Supprimer
pm2 logs hyperemail       # Voir les logs
pm2 monit                 # Monitoring en temps r√©el
```

### **Nginx**

```bash
sudo systemctl status nginx    # Statut
sudo systemctl restart nginx   # Red√©marrer
sudo systemctl reload nginx    # Recharger config
sudo nginx -t                  # Tester config
```

### **Mise √† jour de l'application**

```bash
cd /home/hyperemail/hyperemail
git pull  # Si Git
# Ou transf√©rer les nouveaux fichiers

npm install --production
pm2 restart hyperemail
```

---

## üìä Monitoring

### **Installer PM2 Plus (Optionnel)**

```bash
pm2 link VOTRE_CLE_SECRETE VOTRE_CLE_PUBLIQUE
```

Interface web : https://app.pm2.io

### **Monitoring des ressources**

```bash
# CPU et RAM
htop

# Espace disque
df -h

# Logs en temps r√©el
pm2 logs hyperemail --lines 100
```

---

## üîí S√©curit√© Suppl√©mentaire

### **Fail2Ban (Protection SSH)**

```bash
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### **D√©sactiver le login root**

```bash
sudo nano /etc/ssh/sshd_config
```

Modifier :
```
PermitRootLogin no
```

```bash
sudo systemctl restart sshd
```

### **Mises √† jour automatiques**

```bash
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure --priority=low unattended-upgrades
```

---

## üÜò D√©pannage

### **L'application ne d√©marre pas**

```bash
pm2 logs hyperemail --err
# V√©rifier les erreurs

# V√©rifier les variables d'environnement
cat .env

# V√©rifier Supabase
ls -la /home/hyperemail/firebase-key.json
```

### **Nginx erreur 502**

```bash
# V√©rifier que l'app tourne
pm2 status

# V√©rifier les logs Nginx
sudo tail -f /var/log/nginx/hyperemail-error.log

# Red√©marrer
pm2 restart hyperemail
sudo systemctl restart nginx
```

### **SSL ne fonctionne pas**

```bash
# V√©rifier les certificats
sudo certbot certificates

# Renouveler manuellement
sudo certbot renew --force-renewal

# V√©rifier la config Nginx
sudo nginx -t
```

---

## ‚úÖ Checklist Finale

- [ ] Application accessible sur https://votredomaine.com
- [ ] Certificat SSL valide (cadenas vert)
- [ ] Login fonctionne
- [ ] Scraping fonctionne
- [ ] Supabase connect√©
- [ ] Emails s'envoient
- [ ] PM2 configur√© pour d√©marrage auto
- [ ] Firewall activ√©
- [ ] Logs accessibles
- [ ] Monitoring en place

---

## üìû Support

**En cas de probl√®me :**

1. V√©rifiez les logs : `pm2 logs hyperemail`
2. V√©rifiez Nginx : `sudo nginx -t`
3. V√©rifiez le firewall : `sudo ufw status`
4. Red√©marrez tout : `pm2 restart hyperemail && sudo systemctl restart nginx`

---

## üéâ F√©licitations !

**Votre application HyperEmail est maintenant en production !**

**URL** : https://votredomaine.com  
**Monitoring** : `pm2 monit`  
**Logs** : `pm2 logs hyperemail`

---

¬© 2025 **Maroc Gestion Entreprendre** - Tous droits r√©serv√©s
